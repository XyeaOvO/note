### 4. 局域网 (LANs)：身边的网络世界 🏠🏢

我们已经讨论了链路层的基本服务和多路访问协议。现在，我们将焦点转向一个非常重要的链路层应用场景——**局域网 (Local Area Networks, LANs)**。顾名思义，`LAN` 是指覆盖范围较小的网络，例如一个家庭、一间办公室、一栋教学楼或一个校园内的网络。

在 `LAN` 中，设备之间的通信同样依赖于链路层协议。本节我们将重点关注：

*   **寻址 (Addressing)**: 在 `LAN` 中如何唯一标识设备？这就是 `MAC` 地址的作用。
*   **地址解析协议 (ARP - Address Resolution Protocol)**: 如何将网络层的 `IP` 地址映射到链路层的 `MAC` 地址？
*   **以太网 (Ethernet)**: 最流行的有线 `LAN` 技术。
*   **交换机**: 现代 `LAN` 的核心组件。
*   **虚拟局域网 (VLANs)**: 如何在物理 `LAN` 基础上构建逻辑上隔离的网络。

#### 4.1 MAC 地址：链路层的“身份证号” 🆔

我们知道，在网络层，每个主机接口都有一个全球唯一的 `IP` 地址，用于在整个互联网中进行寻址和路由。那么，在链路层，当一个帧要从一个节点发送到同一链路上的另一个节点时，我们如何标识这些节点呢？答案是使用 `MAC` 地址。

*   **回顾 IP 地址 (32-bit IP address)**:
    *   它是**网络层** 的地址，用于标识网络接口。
    *   用于第3层（网络层）的**转发 (forwarding)**，即路由器根据 `IP` 地址决定数据报的下一跳。
    *   例如：`128.119.40.136`。

*   **MAC 地址 (MAC address)**:
    *   也称为 **LAN 地址 (LAN address)**、**物理地址 (physical address)** 或 **以太网地址 (Ethernet address)**。
    *   **功能**: 用于在**本地 (locally)** 将一个帧从一个网络接口发送到**同一物理链路（或同一子网内，从 IP 寻址意义上看）** 上直接相连的另一个网络接口。
        $\boxed{ \text{MAC 地址用于在链路层实现一跳（hop-by-hop）的帧传输。} }$
    *   **格式**: 大多数 `LAN`（如以太网、`WiFi`）使用 **48 比特 (48-bit)** 的 `MAC` 地址。
        *   通常表示为6个字节的十六进制数，字节之间用冒号 (`:`) 或短划线 (`-`) 分隔。
        *   例如：`1A-2F-BB-76-09-AD`。
    *   **“烧录”在 NIC ROM 中**: `MAC` 地址通常由 `NIC` (网络接口卡) 制造商在生产时**永久地烧录 (burned in)** 到 `NIC` 的只读存储器 (`ROM`) 中。因此，它也被称为硬件地址。
    *   **软件可设**: 虽然理论上是永久的，但很多现代 `NIC` 允许通过软件临时修改其 `MAC` 地址（这有时用于网络管理或某些特殊应用，但也可能被滥用于恶意目的）。

*   **LAN 上的每个接口都有唯一的 MAC 地址**:
    *   在一个局域网内，连接到该 `LAN` 的每个网络接口（无论是主机还是路由器接口）都拥有一个唯一的48位 `MAC` 地址。
    *   同时，这些接口也拥有一个在本地（该子网内）唯一的32位 `IP` 地址。
    *   ![](Pic/Pasted%20image%2020250524204442.png) (图示了一个LAN中多个设备，每个设备都有IP地址和MAC地址)

*   **MAC 地址的分配与管理**:
    *   `MAC` 地址空间的分配由 **IEEE (电气和电子工程师协会)** 负责管理。
    *   `NIC` **制造商 (manufacturer)** 会向 IEEE 购买一段 `MAC` 地址空间（通常是前3个字节，称为组织唯一标识符 `OUI - Organizationally Unique Identifier`），以确保其生产的每个 `NIC` 都拥有全球唯一的 `MAC` 地址。后3个字节由制造商自行分配。
    *   这保证了理论上任何两个 `NIC` 的 `MAC` 地址都不会冲突。

*   **MAC 地址与 IP 地址的类比 (Analogy)**:
    *   **MAC 地址**: 像一个人的**社会安全号码**。它是唯一的、通常是永久的，与个体绑定。
    *   **IP 地址**: 像一个人的**邮政地址 (postal address)**。它标识了设备在网络中的当前位置，当设备移动到不同的网络时，其 `IP` 地址通常会改变。

*   **MAC 地址的“扁平性”与可移植性 (MAC flat address: portability)**:
    *   `MAC` 地址是一个“扁平的 (flat)”地址，它不包含任何网络位置或层次结构信息（不像 `IP` 地址包含网络前缀）。
    *   **可移植性**: 如果你将一个 `NIC`（例如，一块以太网卡）从一台电脑拔下来，插到另一台电脑上，或者将一个便携设备（如笔记本电脑）从一个 `LAN` 移动到另一个 `LAN`，它的 `MAC` 地址**保持不变**。
    *   **IP 地址则不具有这种可移植性**: 当一个设备移动到新的 `IP` 子网时，它通常需要获取一个新的 `IP` 地址以适应新的网络环境。

*   **为什么需要两种地址？**
    *   **IP 地址 (网络层)**: 用于在全球范围内唯一标识主机和网络，并进行**路由选择 (routing)**，决定数据包跨越多个网络的路径。路由器基于 `IP` 地址工作。
    *   **MAC 地址 (链路层)**: 用于在**单个物理网络段（链路或 LAN）** 内唯一标识网络接口，并进行**帧的本地交付 (local delivery)**。交换机主要基于 `MAC` 地址工作。

#### 4.2 ARP：地址解析协议 - IP 到 MAC 的“翻译官” 🗺️

现在我们知道，网络层使用 `IP` 地址，链路层使用 `MAC` 地址。那么，当一个主机（比如A）想要向同一 `LAN` 内的另一个主机（比如B）发送一个 `IP` 数据报时，它知道B的 `IP` 地址（通常是通过 `DNS` 查询或应用程序配置得到），但它需要将这个数据报封装成链路层帧发送出去。帧的头部需要填写B的 `MAC` 地址。

**问题来了**: $\boxed{ \text{主机 A 如何知道主机 B 的 MAC 地址？} }$

这就是**地址解析协议 (ARP - Address Resolution Protocol)** 要解决的问题。`ARP` 的作用就是将一个已知的 `IP` 地址动态地解析（翻译）成对应的 `MAC` 地址。

*   **ARP 表 (ARP Table)**:
    *   在 `LAN` 上的每个 `IP` 节点（主机或路由器接口）都会维护一个 **ARP 表 (ARP table)**，也称为 `ARP` 缓存 (ARP cache)。
    *   这个表存储了**同一局域网内**其他一些节点的 `IP` 地址到 `MAC` 地址的映射关系。
    *   表项通常包含：`<IP address; MAC address; TTL>`
        *   `IP address`: 目标节点的 `IP` 地址。
        *   `MAC address`: 目标节点对应的 `MAC` 地址。
        *   `TTL (Time To Live)`: 该表项的生存时间。当 `TTL` 到期后，该表项会从 `ARP` 表中删除。这确保了 `ARP` 表中的信息不会因为目标节点的 `MAC` 地址改变（例如更换了网卡）而永久失效。`TTL` 通常是几分钟到几十分钟（例如20分钟）。

*   **ARP 协议的工作流程 (ARP protocol in action)**:
    假设主机 A (IP: `IP_A`, MAC: `MAC_A`) 想要向同一 `LAN` 内的主机 B (IP: `IP_B`) 发送一个 `IP` 数据报。

    1.  **主机 A 检查自己的 ARP 表**:
        *   查找是否有 `IP_B` 对应的 `MAC` 地址条目。
        *   **如果找到且未过期**: 太棒了！A直接使用查到的 `MAC_B` 作为目的 `MAC` 地址，封装帧并发送。
        *   **如果没有找到，或者条目已过期**: A 需要启动 `ARP` 过程来获取 `MAC_B`。

    2.  **ARP 请求 (ARP Request)**:
        *   主机 A 构建一个 **ARP 请求报文 (ARP request message)**。这个报文包含：
            *   发送方 `IP` 地址 (`IP_A`)
            *   发送方 `MAC` 地址 (`MAC_A`)
            *   目标 `IP` 地址 (`IP_B`)
            *   目标 `MAC` 地址 (此时未知，通常填全0或留空，表示“我正在请求这个 `MAC` 地址”)
        *   主机 A 将这个 `ARP` 请求报文封装在一个链路层帧中。
            *   **源 MAC 地址**: `MAC_A`
            *   **目的 MAC 地址**: $\boxed{ \text{FF-FF-FF-FF-FF-FF} }$ (这是一个特殊的**广播 MAC 地址 (broadcast MAC address)**)。
            *   帧类型字段：指明上层协议是 `ARP`。
        *   主机 A 将这个**广播帧 (broadcast frame)** 发送到 `LAN` 上。
        *   $\boxed{ \text{局域网内的所有节点都会接收并处理这个广播的 ARP 请求帧。} }$

    3.  **ARP 响应 (ARP Reply)**:
        *   `LAN` 上的每个节点收到 `ARP` 请求帧后，会检查其中的目标 `IP` 地址 (`IP_B`) 是否是自己的 `IP` 地址。
            *   **如果不是**: 该节点通常会默默地丢弃这个 `ARP` 请求。
            *   **如果是 (即主机 B 收到了请求)**: 主机 B 知道 A 正在寻找它的 `MAC` 地址。
        *   主机 B 构建一个 **ARP 响应报文 (ARP reply message)**。这个报文包含：
            *   发送方 `IP` 地址 (`IP_B`)
            *   发送方 `MAC` 地址 (`MAC_B`) (这就是A想要的！)
            *   目标 `IP` 地址 (`IP_A`)
            *   目标 `MAC` 地址 (`MAC_A`)
        *   主机 B 将这个 `ARP` 响应报文封装在一个链路层帧中。
            *   **源 MAC 地址**: `MAC_B`
            *   **目的 MAC 地址**: `MAC_A` (因为B是从A的请求中知道A的 `MAC` 地址的，所以这是一个**单播帧 (unicast frame)**，直接发给A)。
            *   帧类型字段：指明上层协议是 `ARP`。
        *   主机 B 将这个单播帧发送给主机 A。
        *   **顺便学习**: 当主机 B 收到来自 A 的 `ARP` 请求时，B 通常也会在其 `ARP` 表中缓存 A 的 `IP` 地址 (`IP_A`) 和 `MAC` 地址 (`MAC_A`) 的映射关系，以备后用。这是一种优化。

    4.  **主机 A 更新 ARP 表并发送数据**:
        *   主机 A 收到主机 B 的 `ARP` 响应帧后，提取出 `IP_B` 和 `MAC_B` 的映射关系。
        *   将这个映射关系 `<IP_B; MAC_B; TTL>` 添加（或更新）到自己的 `ARP` 表中。
        *   现在，主机 A 知道了 `MAC_B`，于是它可以将之前等待发送的 `IP` 数据报封装成目的 `MAC` 地址为 `MAC_B` 的帧，然后发送给主机 B。

*   **ARP 的关键特性总结**:
    *   **动态性**: `ARP` 表是动态建立和维护的。
    *   **即时性**: 当需要 `MAC` 地址但表中没有时，`ARP` 协议会“即时”去查询。
    *   **本地性**: `ARP` 协议只在**同一个物理局域网（广播域）** 内工作。`ARP` 请求是链路层广播，不会被路由器转发到其他网络。
    *   **无状态性**: `ARP` 本身通常是无状态的，虽然节点会缓存 `ARP` 条目，但请求和响应是一次性的交互。

*   **安全性考虑**: `ARP` 协议本身缺乏安全验证机制，这使得它容易受到 **ARP 欺骗 (ARP spoofing)** 或 **ARP 缓存中毒 (ARP cache poisoning)** 攻击。攻击者可以发送伪造的 `ARP` 响应，将网关或其他主机的 `IP` 地址映射到攻击者自己的 `MAC` 地址，从而截获或篡改受害者的网络流量。

#### 4.3 路由到另一个子网：ARP 如何与路由器协同工作

我们已经了解了在**同一 `LAN` 内**如何通过 `ARP` 获取 `MAC` 地址。那么，如果主机 A 要发送数据报给一个**不同子网**的主机 B 呢？此时，数据报必须通过一个或多个**路由器 (router)** 来转发。

*   **场景设置**:
    *   主机 A (例如 `IP_A = 111.111.111.111`, `MAC_A`)
    *   路由器 R，它有两个接口：
        *   接口1 (连接到A所在的子网): `IP_R1 = 111.111.111.110`, `MAC_R1`
        *   接口2 (连接到B所在的子网): `IP_R2 = 222.222.222.220`, `MAC_R2`
    *   主机 B (例如 `IP_B = 222.222.222.222`, `MAC_B`)

*   **基本假设**:
    *   主机 A 知道主机 B 的 `IP` 地址 (`IP_B`) (例如，通过 `DNS`)。
    *   主机 A 的路由表（或默认网关设置）告诉它，要到达 `IP_B` 所在的网络，下一跳应该是路由器 R 的接口 `IP_R1`。 (A 如何知道 `IP_R1`？通常是通过 `DHCP` 获取的默认网关地址)。
    *   主机 A **最初可能不知道**路由器接口 `MAC_R1` 的地址。

*   **数据报从 A 发送到 B (途经 R) 的寻址过程**:

    1.  **A 准备发送给 R (第一跳)**:
        *   A 创建 `IP` 数据报：
            *   **源 IP 地址**: `IP_A`
            *   **目的 IP 地址**: $\boxed{IP_B}$ (注意：`IP` 头部中的目的 `IP` 地址始终是最终目的地 `IP_B`，在整个传输过程中不会改变)。
        *   A 知道数据报的下一跳是路由器 R (的接口 `IP_R1`)。A 需要将数据报封装成帧发送给 R。因此，A 需要知道 `IP_R1` 对应的 `MAC` 地址 `MAC_R1`。
        *   **A 执行 ARP 过程**:
            *   A 检查其 `ARP` 表是否有 `IP_R1` 的条目。
            *   如果没有，A 会广播一个 `ARP` 请求，请求 `IP_R1` 的 `MAC` 地址。
            *   路由器 R 的接口1 (拥有 `IP_R1`) 收到 `ARP` 请求后，会回复一个 `ARP` 响应，其中包含 `MAC_R1`。
            *   A 将 `<IP_R1; MAC_R1>` 存入其 `ARP` 表。
        *   A 创建链路层帧：
            *   **源 MAC 地址**: `MAC_A`
            *   **目的 MAC 地址**: $\boxed{MAC_{R1}}$ (路由器的入口 `MAC` 地址)
            *   帧类型：IP
            *   帧数据：包含 (源 `IP_A`, 目的 `IP_B`) 的 `IP` 数据报。
        *   A 将此帧发送到 `LAN` 上。

    2.  **R 接收并处理帧**:
        *   路由器 R 的接口1 (`MAC_R1`) 接收到该帧。
        *   R 检查帧的目的 `MAC` 地址，发现是自己的，于是接收该帧。
        *   R 提取出帧中的 `IP` 数据报。
        *   R 查看 `IP` 数据报的目的 `IP` 地址 (`IP_B`)。
        *   R 查询其**路由表 (routing table)**，确定要将该数据报转发到哪个出接口（这里是接口2，连接到 `IP_B` 所在的子网），以及下一跳的 `IP` 地址（如果B不是直接连接在接口2的 `LAN` 上，则下一跳是另一个路由器；如果B是直接连接的，则下一跳就是B本身）。假设B直接连接在R的接口2所在的 `LAN` 上。

    3.  **R 准备发送给 B (第二跳)**:
        *   路由器 R 现在需要将这个 `IP` 数据报（源 `IP_A`, 目的 `IP_B`）从其接口2 (`IP_R2`, `MAC_R2`) 转发给主机 B (`IP_B`)。
        *   R 需要知道 `IP_B` 对应的 `MAC` 地址 `MAC_B`。
        *   **R 在其接口2所在的 LAN 上执行 ARP 过程**:
            *   R (在其接口2的上下文中) 检查其 `ARP` 表是否有 `IP_B` 的条目。
            *   如果没有，R 会从接口2广播一个 `ARP` 请求（源 `IP_R2`, 源 `MAC_R2`, 请求 `IP_B` 的 `MAC`）。
            *   主机 B 收到 `ARP` 请求后，会回复一个 `ARP` 响应，其中包含 `MAC_B`。
            *   R 将 `<IP_B; MAC_B>` 存入其 `ARP` 表 (与接口2关联的 `ARP` 表)。
        *   R 创建新的链路层帧：
            *   **源 MAC 地址**: $\boxed{MAC_{R2}}$ (路由器的出口 `MAC` 地址)
            *   **目的 MAC 地址**: $\boxed{MAC_B}$ (主机B的 `MAC` 地址)
            *   帧类型：IP
            *   帧数据：仍然是那个原始的 `IP` 数据报 (源 `IP_A`, 目的 `IP_B`)。

    4.  **R 发送帧，B 接收**:
        *   R 将这个新的帧从接口2发送出去。
        *   主机 B (`MAC_B`) 接收到该帧。
        *   B 检查帧的目的 `MAC` 地址，发现是自己的，于是接收该帧。
        *   B 提取出帧中的 `IP` 数据报。
        *   B 查看 `IP` 数据报的目的 `IP` 地址 (`IP_B`)，发现是自己的！
        *   B 将数据报传递给其网络层，再由网络层传递给适当的运输层协议（如 `TCP` 或 `UDP`）。

*   **关键点回顾**:
    *   $\boxed{ \text{IP 地址（源和目的）在数据报从源到最终目的地的整个过程中通常保持不变。} }$
    *   $\boxed{ \text{MAC 地址（源和目的）在数据报的每一跳（hop-by-hop）都会改变。} }$
        *   源 `MAC` 地址是发送方接口的 `MAC`。
        *   目的 `MAC` 地址是该链路上下一跳接收方接口的 `MAC`。
    *   `ARP` 协议用于解析**下一跳**的 `IP` 地址到 `MAC` 地址的映射。
        *   主机 `ARP` 自己子网内的默认网关（路由器）的 `MAC` 地址。
        *   路由器 `ARP` 它要转发到的下一个子网内的目标主机（或下一个路由器）的 `MAC` 地址。

---
#### 4.4 以太网 (Ethernet)：局域网的常青树 🌳

以太网是当今应用最为广泛的有线局域网技术。从最初的共享总线型网络到现代的交换式网络，以太网不断发展，速率也从几 Mbps 飙升到数百 Gbps 甚至 Tbps。

*   **历史与地位**:
    *   以太网是**第一个被广泛使用的 `LAN` 技术**。
    *   它被认为是“**占主导地位 (dominant)**”的有线 `LAN` 技术。
    *   **特点**: 相对**简单 (simpler)**、**廉价 (cheap)**。
    *   **不断演进**: 成功地跟上了速率的竞赛，从 `10 Mbps` $\rightarrow$ `100 Mbps` (快速以太网) $\rightarrow$ `1 Gbps` (千兆以太网) $\rightarrow$ `10 Gbps` $\rightarrow$ `40 Gbps` $\rightarrow$ `100 Gbps` 甚至更高 (如 `400 Gbps`)。
    *   **高度集成**: 现代以太网控制器通常是**单芯片 (single chip)** 解决方案，并且一个芯片可以支持多种速率 (例如，博通 `Broadcom BCM5761` 芯片)。

*   **以太网的物理拓扑演变 (Ethernet: physical topology)**:
    1.  **总线型 (Bus Topology)**:
        *   流行于上世纪80年代中期到90年代中期。
        *   所有节点共享一根同轴电缆 (coaxial cable)。
        *   在总线型以太网中，所有节点都处于同一个碰撞域 (collision domain) 内，它们发送的信号都可能发生碰撞。
        *   采用 `CSMA/CD` 协议进行介质访问控制。
    2.  **星型/ 交换式**:
        *   目前主流的拓扑结构。
        *   中心是一个**链路层交换机 (link-layer 2 switch)** (或集线器 `hub`，但集线器已经很少见，它在逻辑上仍是总线型)。
        *   每个节点通过一条独立的链路（通常是双绞线或光纤）连接到交换机的一个端口上。
        *   **使用交换机时**:
            *   每个端口通常构成一个**独立的碰撞域**。如果连接的是全双工设备，则该端口上不会发生碰撞。
            *   每个“辐条 (spoke)”（即节点到交换机的链路）都运行独立的以太网协议。
            *   现代交换式以太网通常工作在**全双工 (full-duplex)** 模式，节点可以同时发送和接收数据，无需 `CSMA/CD` 的碰撞检测机制（或者说，`CSMA/CD` 机制可以被禁用）。
    *   ![](Pic/Pasted%20image%2020250529144749.png)

##### 4.4.1 以太网帧结构

当发送接口（如 `NIC`）要发送一个 `IP` 数据报（或其他网络层协议分组）时，它会将其封装在一个以太网帧中。以太网帧有固定的结构。

*   **以太网帧各字段**:
    ![](Pic/Pasted%20image%2020250529145134.png)

    1.  **前同步码 (Preamble) (8 字节)**:
        *   **目的**: 用于接收方 `NIC` 与发送方 `NIC` 的**时钟同步 (synchronize receiver, sender clock rates)**。接收方通过检测前同步码的比特模式来锁定比特流的开始，并调整其采样时钟。
        *   **内容**:
            *   前7个字节是 `10101010` 的交替模式。
            *   第8个字节是**帧起始定界符**，其值为 `10101011`。SFD 的最后两位 `11` 标志着实际的帧内容即将开始。
        *   注：前同步码和 SFD 在物理层处理，有时不被认为是严格意义上链路层帧的一部分，但它们对于以太网的运作至关重要。

    2.  **目的 MAC 地址 (Destination MAC Address) (6 字节)**:
        *   接收该帧的目标网络接口的 `MAC` 地址。
        *   可以是单播 `MAC` 地址（发给特定节点）、多播 `MAC` 地址（发给一组节点）或广播 `MAC` 地址 (`FF-FF-FF-FF-FF-FF`，发给 `LAN` 上的所有节点)。

    3.  **源 MAC 地址(6 字节)**:
        *   发送该帧的网络接口的 `MAC` 地址。

    4.  **类型 (Type) / 长度 (Length) (2 字节)**:
        *   这个字段有两种解释，取决于其值：
            *   **如果值 $\ge 1536$ (或 $0x0600$)**: 则表示**类型 (Type)** 字段。它指明了帧的数据部分（`payload`）所承载的上层协议是什么。
                *   例如：`0x0800` 表示 `IP` 数据报 (`IPv4`)。
                *   `0x0806` 表示 `ARP` 报文。
                *   `0x86DD` 表示 `IPv6` 数据报。
                *   这个字段用于接收方进行**分用 (demultiplex)**，将数据负载传递给正确的上层协议处理模块。
            *   **如果值 $< 1536$**: 则表示**长度 (Length)** 字段 (这是 IEEE 802.3 标准的原始定义)。它指明了数据部分的长度（字节数）。在这种情况下，上层协议类型需要通过其他方式（如 LLC 子层）来标识。
        *   现代以太网（通常称为以太网 II 帧格式或 DIX 帧格式）主要使用此字段作为**类型字段**。

    5.  **数据 (Data / Payload) (46 - 1500 字节)**:。
        *   包含从网络层传递下来的数据报（例如 `IP` 数据报）
        *   **最小长度**: 如果数据报的长度小于46字节，则必须进行**填充 (padding)**，使其达到46字节。这是为了确保帧长足够长，以便在 `CSMA/CD` 网络中能可靠地检测到碰撞（帧的发送时间必须大于信号在网络中往返传播的最大时间）。
        *   **最大长度**: 通常是1500字节（对应 `IP` 层的 `MTU - Maximum Transmission Unit`）。如果 `IP` 数据报大于1500字节，则需要在 `IP` 层进行分片。
        *   支持巨型帧 (Jumbo Frames) 的网络允许更大的 `payload` (例如9000字节)，但这需要在整个路径上的设备都支持。

    6.  **CRC (Cyclic Redundancy Check) (4 字节)**:
        *   帧校验序列 (Frame Check Sequence, FCS)。
        *   发送方对目的地址、源地址、类型和数据字段计算出的32位 `CRC` 值。
        *   接收方收到帧后，对相同字段重新计算 `CRC`，并与接收到的 `CRC` 值进行比较。
		*   如果 CRC 校验失败（不匹配），接收方通常会丢弃该帧 (error detected: frame is dropped)。以太网本身不提供重传服务。

*   **帧处理逻辑 (基于目的 MAC 地址和类型字段)**:
    *   当一个 `NIC` 接收到一个以太网帧时：
        1.  它首先检查帧的 `CRC` 是否正确。如果错误，则丢弃。
        2.  如果 `CRC` 正确，它会检查帧中的**目的 `MAC` 地址**。
            *   如果目的 `MAC` 地址是该 `NIC` 自己的 `MAC` 地址，或者是广播地址 (`FF-FF-FF-FF-FF-FF`)，或者是该 `NIC` 正在监听的某个多播地址，那么该 `NIC` 会接受这个帧，并将其数据部分根据**类型字段**传递给相应的上层协议（例如，如果类型是 `0x0800`，就传给 `IP` 协议栈）。
            *   否则（目的 `MAC` 地址与本 `NIC` 无关），`NIC` 会丢弃该帧。

##### 4.4.2 以太网的特性：不可靠、无连接

*   **无连接 (Connectionless)**:
    *   发送方和接收方 `NIC` 之间在数据传输前**没有握手 (no handshaking)** 过程。
    *   发送方直接将帧发送出去，不事先建立连接。
*   **不可靠 (Unreliable)**:
    *   接收方 `NIC` 在收到正确的帧后，**不会向发送方发送确认帧 (ACKs)**。
    *   如果一个帧因为碰撞、`CRC` 错误或其他原因被丢弃，发送方 `NIC` 不会知道，也不会自动重传。
    *   $\boxed{ \text{以太网层面不保证帧的可靠交付。可靠性需要由更高层协议（如 TCP）来提供。} }$
        *   如果上层使用 `TCP`，那么丢失的数据会在 `TCP` 层通过超时重传机制得到恢复。
        *   如果上层使用 `UDP`，那么丢失的数据就真的丢失了（除非应用程序自己实现了可靠性）。
*   **MAC 协议**:
    *   传统的共享介质以太网使用**非时隙的 CSMA/CD (unslotted CSMA/CD)** 协议，并采用**二进制指数退避 (binary backoff)** 算法来处理碰撞。
    *   现代交换式以太网，如果端口是全双工的，则不再需要 `CSMA/CD`。

##### 4.4.3 以太网标准的多样性 (802.3 Ethernet standards: link & physical layers)

以太网是一个庞大的标准家族 (IEEE 802.3 系列标准)。虽然它们在 `MAC` 协议（逻辑链路控制 `LLC` 子层和 `MAC` 子层）和帧格式上保持了很大程度的兼容性，但在物理层（介质、速率、编码方式等）则有多种多样的实现。

*   **共同点**:
    *   通常共享相同的 `MAC` 协议和帧格式（或高度兼容的变体）。
*   **差异点**:
    *   **速率**: `2 Mbps` (早期版本，已淘汰), `10 Mbps` (标准以太网), `100 Mbps` (快速以太网), `1 Gbps` (千兆以太网), `10 Gbps`, `40 Gbps`, `100 Gbps` 等。
    *   **物理介质 (Physical layer media)**:
        *   **铜缆 (Copper)**: 如双绞线 (twisted pair - TP)，例如 `10BASE-T`, `100BASE-TX`, `1000BASE-T`。
        *   **光纤 (Fiber)**: 如 `100BASE-FX`, `1000BASE-SX`, `1000BASE-LX`, `10GBASE-SR/LR/ER` 等。
        *   同轴电缆 (Coax): 如 `10BASE5` (粗缆), `10BASE2` (细缆)，已较少使用。
*   **标准命名约定 (示例)**:
    *   `100BASE-TX`:
        *   `100`: 速率为 `100 Mbps`。
        *   `BASE`: 表示基带 (Baseband) 传输（与宽带 `BROAD` 相对）。
        *   `T`: 表示介质为双绞线 (Twisted pair)。
        *   `X` (或其他字母如 `F`, `S`, `L`): 表示特定的编码方案或光纤类型/波长。
*   **分层视角**:
    *   应用层 $\rightarrow$ 运输层 $\rightarrow$ 网络层 $\rightarrow$ **链路层 (MAC 协议和帧格式)** $\rightarrow$ **物理层 (多种实现)**
    *   ![](Pic/Pasted%20image%2020250529151631.png)

---
#### 4.5 链路层交换机 (Ethernet Switch)：现代 LAN 的交通枢纽 🚦

在现代以太网中，**交换机 (switch)** 取代了早期的集线器 (`hub`) 和共享总线，成为了局域网的核心组件。交换机在链路层工作，能够显著提高 `LAN` 的性能和效率。

*   **交换机的基本特性**:
    *   交换机是一个链路层设备 (link-layer device)，它在转发决策中扮演主动角色 (takes an active role)。
    *   **存储转发**: 交换机接收到完整的以太网帧后，会将其暂时存储在内部缓冲区，然后根据目的 `MAC` 地址决定从哪个端口转发出去。
    *   **选择性转发**: 交换机**检查 (examine)** 入侵帧的**目的 `MAC` 地址**，并**选择性地 (selectively)** 将该帧只转发到通往该目的 `MAC` 地址的那个**输出端口 (outgoing link)**。它不会像集线器那样将帧广播到所有其他端口（除非目的 `MAC` 地址未知或为广播/多播地址）。
    *   如果输出端口所在的网段是共享介质（虽然现代很少见，但理论上可能），交换机在向该网段发送帧时仍需使用 `CSMA/CD` 来接入。
    *   **透明性 (Transparent)**: 对于连接到交换机的主机来说，交换机的存在通常是**透明的 (unaware of presence of switches)**。主机不需要进行任何特殊配置就知道交换机的存在，它们就像直接连接在一个 `LAN` 上一样。
    *   **即插即用 (Plug-and-play)** 和 **自学习**:
        *   交换机通常是即插即用的，不需要进行复杂的配置。
        *   它们具有自学习能力，能够自动学习 `LAN` 中各个 `MAC` 地址所连接的端口位置。

*   **交换机如何实现多路并发传输**:
    *   **专用连接**: 每个连接到交换机的主机都拥有到交换机端口的**专用 (dedicated)**、直接的链路。
    *   **缓冲数据包**: 交换机内部有缓冲区，可以暂存待转发的帧。
    *   **独立的以太网协议**: 交换机与每个连接设备之间的链路都运行独立的以太网协议。
        *   $\boxed{ \text{在交换式以太网中，通常没有碰撞 (no collisions)；可以实现全双工 (full duplex) 通信。} }$
        *   **每个链路本身就是一个独立的碰撞域 (each link is its own collision domain)**。由于每个端口通常只连接一个设备（或另一个交换机），并且可以全双工运行，所以实际上碰撞很少发生或不发生。
    *   **并发能力**: 这是交换机相比集线器的巨大优势。由于交换机可以根据目的 `MAC` 地址将帧只转发到特定端口，因此**多对端口之间可以同时进行数据传输而互不干扰**。
        *   例如：如果 A 要发送给 A'，同时 B 要发送给 B'，并且它们连接在交换机的不同端口对上，那么这两对通信**可以并发进行 (A-to-A' and B-to-B' can transmit simultaneously, without collisions)**。
        *   ![](Pic/Pasted%20image%2020250529152147.png)
        *   但是，如果 A 要发给 A'，同时 C 也要发给 A'（即多个源发往同一个目的端口），那么这些帧在输出到 A' 的端口时仍然需要排队，不能同时发送.

##### 4.5.1 交换机转发表与自学习

交换机如何知道应该将一个帧从哪个端口转发出去呢？它依赖于一个内部的**交换机转发表 (switch table)**，也称为 `MAC` 地址表或内容可寻址存储器 (`CAM` table)。

*   **交换机转发表**:
    *   **问题 (Q)**: 交换机如何知道 A' 可以通过接口4到达，B' 可以通过接口5到达？
    *   **回答 (A)**: 每个交换机都有一个交换表。表中的每个条目通常包含：
        *   **`MAC` 地址 (MAC address of host)**: `LAN` 上某个主机的 `MAC` 地址。
        *   **接口 (Interface to reach host)**: 交换机上连接到该主机的端口号。
        *   **时间戳 (Time stamp)**: 该条目的老化时间。如果一个条目在一段时间内没有被使用（即没有收到来自该 `MAC` 地址的帧），它可能会被删除，以保持表的时效性。
    *   $\boxed{ \text{交换机转发表看起来有点像路由器的路由表，但它映射的是 MAC 地址到端口，而不是 IP 网络到下一跳。} }$
    *   ![](Pic/Pasted%20image%2020250529152726.png)

*   **转发表条目是如何创建和维护的？——自学习**:
    *   **问题 (Q)**: 表中的条目是如何创建和维护的？是否像路由协议那样有专门的协议？
    *   **回答 (A)**: 不，交换机采用一种非常聪明的**自学习 (self-learning)** 算法。
    *   **自学习过程**:
        1.  当交换机从某个端口（例如端口 `x`）收到一个帧时，它会**检查该帧的源 `MAC` 地址 (source MAC address)**，假设为 `MAC_S`。
        2.  交换机就知道：`MAC_S` 这个地址的主机是可以通过端口 `x` 到达的。
        3.  交换机会在其转发表中查找 `MAC_S`。
            *   **如果表中没有 `MAC_S` 的条目**: 交换机将 `<MAC_S, x, current_time>` 这个新条目添加到表中。
            *   **如果表中有 `MAC_S` 的条目，但记录的端口不是 `x` 或者时间戳已旧**: 交换机会更新该条目，将其端口改为 `x`，并更新时间戳。
        *   $\boxed{ \text{通过监听每个进入帧的源 MAC 地址，交换机“学习”到网络中各个 MAC 地址的位置。} }$

##### 4.5.2 交换机的帧过滤/转发逻辑

一旦交换机通过自学习建立（或部分建立）了转发表，它就可以高效地处理进入的帧了。

当交换机从某个端口收到一个帧后，其处理流程如下：

1.  **记录/学习源地址**: 记录该帧的源 `MAC` 地址及其到达的端口号到交换机转发表中（如上一节所述的自学习过程）。
2.  **查找目的地址**: 使用帧中的**目的 `MAC` 地址**去查询交换机转发表。
3.  **根据查找结果进行决策**:
    *   **情况1: 表中找到了与目的 `MAC` 地址匹配的条目**。
        *   设该条目指示目的主机位于端口 `y`。
        *   **如果端口 `y` 就是该帧进入的端口 `x` (if destination on segment from which frame arrived)**: 这意味着发送方和接收方在同一个网段（例如，如果这个端口连接的是一个集线器，而发送方和接收方都在该集线器上）。此时，交换机**不需要转发该帧 (then drop frame)**，因为它们已经在同一广播域内，接收方应该已经能收到。这个操作称为**过滤 (filtering)**。
        *   **如果端口 `y` 不是该帧进入的端口 `x` (else forward frame on interface indicated by entry)**: 交换机将该帧**只从端口 `y` 转发出去**。这实现了选择性转发。
    *   **情况2: 表中没有找到与目的 `MAC` 地址匹配的条目 (else flood)** (或者目的 `MAC` 地址是广播地址/未知多播地址):
        *   这意味着交换机当前不知道如何到达该目的 `MAC` 地址。
        *   此时，交换机将采取**泛洪 (flood)** 的策略：$\boxed{ \text{将该帧转发到除了它进入的那个端口之外的所有其他活动端口。} }$
        *   这确保了如果目标主机确实存在于 `LAN` 的某个地方（并且该 `MAC` 地址是正确的），它最终能收到这个帧。同时，如果目标主机响应了这个泛洪的帧，交换机就能从响应帧的源 `MAC` 地址学习到它的位置。

*   **自学习、转发与泛洪示例**:
    *   初始时，交换机表是空的。
    *   1. A (端口1) 发送帧给 A' (假设A'的MAC未知)。
        *   交换机学习到 A 在端口1：表中添加 `(A, 1, TTL)`。
        *   由于 A' 的 `MAC` 地址在表中未知，交换机将该帧从端口 2, 3, 4, 5, 6 **泛洪**出去。
    *   2. 假设 A' (位于端口4) 收到帧后，回复一个帧给 A。
        *   交换机从端口4收到该帧，源 `MAC` 是 A'。交换机学习到 A' 在端口4：表中添加 `(A', 4, TTL)`。
        *   目的 `MAC` 是 A。交换机查表，发现 A 在端口1。于是将该帧**只从端口1转发**给 A。

##### 4.5.3 互连交换机

可以通过将多个交换机互连起来，构建更大规模的局域网。自学习机制在多交换机环境下依然有效。

*   **工作原理**:
    *   当帧从一个交换机（例如S1）转发到另一个交换机（例如S4）时，S4会像处理来自普通主机的帧一样，学习到S1那边可达的 `MAC` 地址（实际上是S1从该帧的源 `MAC` 学习到的）。
    *   例如，A (连接S1) 发送帧给 G (连接S3，S3又连接S4，S4又连接S1)。
        *   当帧到达S1时，S1学习A的位置。如果G未知，S1泛洪，帧会到达S4。
        *   S4从连接S1的端口收到帧，学习到A可以通过该端口（即通过S1）到达。如果G未知，S4泛洪，帧会到达S3。
        *   S3从连接S4的端口收到帧，学习到A可以通过该端口（即通过S4再通过S1）到达。如果G未知，S3泛洪，G收到帧。
        *   当G回复帧给A时，S3学习G的位置，并将帧发往S4。S4学习G的位置（通过S3），并将帧发往S1。S1学习G的位置（通过S4），并将帧发往A。
    *   $\boxed{ \text{多交换机环境下的自学习与单交换机情况完全一样，每个交换机独立维护自己的转发表。} }$
    
*   **潜在问题：环路 (Loops)**
    *   如果交换机之间连接形成了环路（例如，S1-S2-S3-S1），那么没有目的地址的广播帧或未知单播帧会在环路中无限循环地泛洪，导致**广播风暴 (broadcast storm)**，迅速耗尽网络带宽和交换机处理能力。
    *   为了解决这个问题，交换网络需要运行**生成树协议**。STP 会在逻辑上阻塞某些冗余链路，确保在任意两个交换机之间只有一条活动的路径，从而消除环路，同时保留冗余链路作为备用。
##### 4.5.4 交换机 vs. 路由器

交换机和路由器都是网络中的关键设备，都执行存储转发，都有转发表，但它们工作在不同的协议层，功能和特性也有显著区别。

| 特性         | 交换机                                                 | 路由器 (Router)                                                              |
| ---------- | --------------------------------------------------- | ------------------------------------------------------------------------- |
| **工作层面**   | **链路层 (Layer 2)**                                   | **网络层 (Layer 3)**                                                         |
| **处理的PDU** | 帧 (Frame)                                           | 数据包/数据报 (Packet/Datagram)                                                 |
| **查看的地址**  | `MAC` 地址                                            | `IP` 地址                                                                   |
| **转发表**    | `MAC` 地址表 (交换表)                                     | 路由表 (Routing table)                                                       |
| **表建立方式**  | **自学习**, 泛洪 (Flooding)                              | **路由算法/协议 (Routing algorithms/protocols)** (如 `RIP`, `OSPF`, `BGP`)，或静态配置 |
| **数据报处理**  | 通常不修改帧内容 (除了可能的VLAN标签)                              | 修改 `IP` 数据包头部 (如TTL减1, 重新计算校验和)                                           |
| **广播域**    | 连接到交换机的所有端口（默认情况下）属于同一个广播域。交换机**不隔离广播域**（除非使用VLAN）。 | 每个路由器接口连接一个独立的广播域。路由器**隔离广播域**，不转发链路层广播。                                  |
| **碰撞域**    | 每个端口是一个独立的碰撞域。                                      | 每个接口连接一个独立的碰撞域。                                                           |
| **主要功能**   | 在**单个局域网 (LAN)** 内高效转发帧。                            | 在**多个网络 (WAN/Internet)** 之间路由数据包，实现网络互连。                                  |
| **网络规模**   | 主要用于构建局域网。                                          | 用于连接局域网和广域网，构建大规模互联网。                                                     |
| **对上层透明性** | 对网络层透明。                                             | 对运输层及以上通常不透明（IP地址是可见的）。                                                   |

*   **图示对比**:
    *   当数据从主机通过交换机到达路由器，再通过路由器到达另一个网络的主机时：
        *   **交换机 (switch)**: 仅处理到链路层。它查看帧的 `MAC` 地址，根据 `MAC` 表转发。
        *   **路由器 (router)**: 帧到达路由器后，解封装到网络层。路由器查看 `IP` 数据报的 `IP` 地址，根据路由表决定下一跳，然后重新封装成新的链路层帧（可能使用不同的链路层协议和 `MAC` 地址）发送出去。

---
### 5. 虚拟局域网 (VLANs)：灵活划分广播域

随着局域网规模的扩大，如果所有设备都在同一个广播域内，可能会带来一些问题：

*   **广播流量过大**: `ARP` 请求、`DHCP` 请求、未知单播帧的泛洪等广播/多播流量会发送到网络中的所有设备，消耗带宽和设备处理能力。
*   **安全性/隐私性差**: 同一广播域内的设备可以轻易地嗅探到其他设备的流量（例如通过 `ARP` 欺骗）。
*   **管理不便**: 如果需要将不同部门或用户组在逻辑上隔离，但在物理上它们可能连接在同一个交换基础设施上，传统的 `LAN` 难以实现。
* 例如，一个计算机科学系 (CS) 的用户搬到了电气工程系 (EE) 的办公室，物理上连接到了EE部门的交换机，但他希望在逻辑上仍然属于CS系的广播域（例如，能访问CS系的服务器，获取CS系的 `DHCP` 配置）。
* ![](Pic/Pasted%20image%2020250529154524.png)

**虚拟局域网 (Virtual LANs, VLANs)** 技术应运而生，用于解决这些问题。

*   **VLAN 的核心思想**:
    $\boxed{ \text{VLAN 允许在单个物理 LAN 基础设施上，通过交换机的配置，创建多个逻辑上独立的广播域。} }$
    *   支持 `VLAN` 功能的交换机可以被配置来定义多个**虚拟的 (virtual)** `LAN`。
    *   每个 `VLAN` 构成一个独立的广播域。一个 `VLAN` 内的广播流量不会传播到其他 `VLAN`。
    *   不同 `VLAN` 之间的通信必须通过**路由器 (Layer 3 routing)** 来实现，就像它们是物理上分离的网络一样。

*   **基于端口的 VLAN (Port-based VLANs)**:
    *   这是最常见的 `VLAN`划分方式。
    *   通过交换机管理软件，将交换机的**物理端口 (switch ports)** 分组到不同的 `VLAN` 中。
    *   例如：一个物理交换机上的端口1-8被划分为 `VLAN 10` (例如EE系)，端口9-16被划分为 `VLAN 20` (例如CS系)。
        *   这个**单个物理交换机 (single physical switch)** 在逻辑上就像是**多个独立的虚拟交换机 (multiple virtual switches)**。
        *   ![](Pic/Pasted%20image%2020250529154322.png)
    *   **流量隔离**:
        *   从 `VLAN 10` (端口1-8) 进入的帧，如果其目的 `MAC` 地址也在 `VLAN 10` 内（即也在端口1-8上），则只会在端口1-8之间转发。它们**不能 (can only reach ports 1-8)** 直接到达 `VLAN 20` (端口9-16) 的设备。
        *   同样，`VLAN 10` 内的广播帧只会泛洪到 `VLAN 10` 的其他端口，不会进入 `VLAN 20`。
    *   **动态成员关系**: 某些高级交换机还支持基于 `MAC` 地址、协议类型等动态分配 `VLAN` 成员关系，而不仅仅是基于物理端口。
    *   **VLAN 间转发**:
        *   $\boxed{ \text{不同 VLAN 之间的通信必须通过路由器（或三层交换机）进行路由。} }$
        *   这就像将两个物理上独立的 `LAN` 通过路由器连接起来一样。
        *   在实践中，很多企业级交换机集成了三层路由功能（称为三层交换机 `Layer 3 switch` 或多层交换机 `multilayer switch`），可以直接在 `VLAN` 间进行路由。
    *   ![](Pic/Pasted%20image%2020250529154443.png) (图示了单个交换机配置了两个VLAN，需要外部路由器或三层功能进行VLAN间通信)

*   **跨多个交换机的 VLAN**:
    *   通常，一个 `VLAN` 可能需要跨越多个物理交换机。例如，CS系的设备可能连接在不同楼层的多个交换机上，但它们都属于同一个CS `VLAN`。
    *   **干道端口**:
        *   为了在多个交换机之间传递不同 `VLAN` 的流量，交换机之间需要配置**干道端口 **。
        *   一个干道端口可以承载**多个 `VLAN` 的帧**。
    *   **帧标记**:
        *   当一个帧需要通过干道端口从一个交换机发送到另一个交换机时，如果它是属于某个特定 `VLAN` 的，那么这个帧**必须携带 `VLAN ID` 信息**，以便接收交换机知道这个帧属于哪个 `VLAN`。普通的以太网帧格式没有地方放 `VLAN ID`。
        *   **IEEE 802.1Q 标准**: 定义了在以太网帧中添加 `VLAN` 标签的方法。
            *   `802.1Q` 协议在源 `MAC` 地址和类型字段之间**插入 (adds/removed additional header fields)** 一个4字节的**标签 (tag)**。
            *   这个标签包含了 `VLAN ID` (12位，可以支持4094个VLAN)、优先级等信息。
            *   当帧进入干道端口时，交换机（如果帧来自接入端口且属于某个VLAN）会给它打上 `802.1Q` 标签。当帧从干道端口出来，要转发到属于该 `VLAN` 的接入端口时，交换机会移除标签。
    *   ![](Pic/Pasted%20image%2020250529154735.png) (图示了两个交换机通过trunk port连接，trunk port上传输带VLAN标签的帧)

*   **802.1Q VLAN 帧格式 (802.1Q VLAN frame format)**:
    *   标准的以太网帧 (802.1 Ethernet frame):
        `Preamble | Dest MAC | Src MAC | Type | Payload | CRC`
    *   `802.1Q` 标记的以太网帧 (802.1Q frame):
        `Preamble | Dest MAC | Src MAC | 802.1Q Tag (4 bytes) | Type' | Payload | CRC'`
        *   **802.1Q Tag (4 字节)**:
            *   **Tag Protocol Identifier (TPID) (2 字节)**: 固定值为 `0x8100`。当交换机看到这个值时，就知道后面跟着的是 `VLAN` 标签信息，而不是真正的类型字段。
            *   **Tag Control Information (TCI) (2 字节)**:
                *   **Priority Code Point (PCP) (3 比特)**: 用于服务质量 (QoS) 的优先级标记 (类似 IP TOS)。
                *   **Drop Eligible Indicator (DEI) (1 比特)**: (以前叫 CFI - Canonical Format Indicator) 指示在拥塞时该帧是否可以被优先丢弃。
                *   **VLAN ID (VID) (12 比特)**: 标识该帧所属的 `VLAN`。可以表示 $2^{12} = 4096$ 个 `VLAN`，其中 `VID=0` 和 `VID=4095 (0xFFF)` 是保留的，所以实际可用 $1$ 到 $4094$。
        *   **Type'**: 原始的类型字段现在位于 `802.1Q` 标签之后。
        *   **CRC'**: 由于帧的内容（增加了标签）和长度都改变了，所以**必须重新计算 CRC (Recomputed CRC)**。
    *   ![](Pic/Pasted%20image%2020250529154946.png)

---
### 4.7 链路虚拟化：MPLS

虽然 `MPLS` (Multiprotocol Label Switching) 通常被认为工作在 OSI 模型的第2.5层（介于链路层和网络层之间），但它提供了一种“链路虚拟化”或“标签交换”的机制，与传统的 `IP` 路由有所不同，值得在此处提及。

*   **MPLS 的目标**:
    *   在 `MPLS` 能力的路由器网络中实现**高速的 `IP` 转发 (high-speed IP forwarding)**。
    *   它使用**固定长度的标签** 来进行转发决策，而不是像传统 `IP` 路由那样进行最长前缀匹配查找，后者可能更耗时。
    *   $\boxed{ \text{MPLS 的核心思想：基于短而定长的标签进行交换，而不是复杂的 IP 地址查找。} }$
    *   **借鉴了虚电路的思想**: `MPLS` 路径（称为标签交换路径 `LSP - Label Switched Path`）在数据传输前需要建立，有点像虚电路。
    *   **但 IP 数据报仍然保留其 IP 地址**: `MPLS` 标签只是在 `MPLS` 网络内部用于转发，数据报本身的 `IP` 头部（源/目的 `IP` 地址）保持不变。

*   **MPLS 头部**:
    *   `MPLS` 标签通常封装在一个“垫片头部”中，这个头部插入在链路层头部（如以太网头部）和网络层头部（`IP` 头部）之间。
    *   一个典型的 `MPLS` 标签头部 (4字节 = 32比特) 包含：
        *   **标签值 (Label) (20 比特)**: 用于在 `MPLS` 路由器上查找转发表。
        *   **实验位 (Exp - Experimental) (3 比特)**: 通常用于服务质量 (QoS) 或区分服务。
        *   **栈底位(1 比特)**: 如果为1，表示这是标签栈中的最后一个标签（`MPLS` 支持标签嵌套/堆叠）。
        *   **TTL (Time-to-Live) (8 比特)**: 与 `IP TTL` 类似，用于防止标签包在网络中无限循环。
    *   ![](Pic/Pasted%20image%2020250529155611.png) (图示了以太网帧中插入MPLS标签的情况)

*   **MPLS 能力路由器**:
    *   也称为**标签交换路由器 (LSR - Label-Switched Router)**。
    *   `LSR` 根据仅基于入标签的值，在**标签转发表 (MPLS forwarding table, LFIB)** 中查找对应的出标签和出接口，然后进行标签交换（用出标签替换入标签）并转发。
    *   `MPLS` 转发表与 `IP` 转发表 (路由表) 是分离的。
    *   **灵活性 (Flexibility)**:
        *   `MPLS` 的转发决策**可以不同于** 基于纯 `IP` 路由的决策。
        *   可以实现**流量工程**: 例如，根据源 `IP` 地址和目的 `IP` 地址（或其他标准）将去往同一最终目的地的不同数据流导向不同的 `LSP` 路径，以实现负载均衡或满足特定 QoS 要求。
        *   可以实现**快速重路由**: 如果主 `LSP` 发生故障，可以预先计算并建立好备用 `LSP`，从而快速切换流量，减少中断时间。

*   **MPLS 路径 vs. IP 路径**:
    *   **IP 路由**: 路径通常只由**目的 IP 地址单独决定 (determined by destination address alone)** (基于路由表的最长前缀匹配)。
    *   **MPLS 路由**: 路径 (`LSP`) 的建立可以基于多种标准，例如**源和目的 IP 地址 (source and destination address)**，或其他策略。
        *   这使得 `MPLS` 可以实现比传统 `IP` 路由更灵活的路径选择。
        *   `MPLS` 实际上是广义转发 (Generalized Forwarding) 的一种早期实现。
        *   ![](Pic/Pasted%20image%2020250529155816.png) (图示了对于相同的源A和目的D，IP路由可能只有一条路径，而MPLS入口路由器R4可以根据额外信息（如A的源地址）选择不同的MPLS路径)

*   **MPLS 信令**:
    *   `LSP` 的建立需要信令协议。
    *   **路由信息分发**: `MPLS` 可以利用现有的 `IP` 路由协议（如 `OSPF`, `IS-IS`）的扩展来分发标签映射信息，或者携带用于 `LSP` 路径计算的链路属性（如可用带宽）。这些被称为 IGP 扩展 (e.g., OSPF-TE, ISIS-TE)。
    *   **LSP 建立**:
        *   可以使用 **LDP (Label Distribution Protocol)** 在相邻 `LSR` 之间自动分发标签。
        *   或者使用 **RSVP-TE (Resource Reservation Protocol - Traffic Engineering)** 来显式地建立具有特定资源保证（如带宽）和路径约束的 `LSP`。入口 `LSR` (Ingress LSR) 使用 `RSVP-TE` 向下游 `LSR` 发送路径建立请求。
    *   ![](Pic/Pasted%20image%2020250529160001.png) (图示了R4作为入口LSR，通过RSVP-TE信令沿R3-R2-R1路径建立LSP，同时IGP可能在扩散链路状态信息)

*   **MPLS 转发表示例**:
    *   每个 `LSR` 维护一个或多个标签信息库 (`LIB`) 和一个标签转发表 (`LFIB`)。
    *   `LFIB` 表项通常包含：`In Label | Out Interface | Out Label | Next Hop` (有时还有其他操作如 `PUSH`, `POP`, `SWAP`)。
    *   数据包沿着 `LSP` 逐跳转发，每个 `LSR` 执行标签查找、标签交换（或压入/弹出）和转发。
    *   ![](Pic/Pasted%20image%2020250529160124.png)

`MPLS` 是一项复杂但功能强大的技术，广泛应用于运营商骨干网，用于流量工程、VPN 服务、QoS保证等。

---
