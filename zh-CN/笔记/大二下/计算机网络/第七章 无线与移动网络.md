# 第七章 无线与移动网络

你好！欢迎来到第七章的学习！在这一章，我们将一同探索日益重要的**无线与移动网络**的世界。你可能每天都在使用它们——手机的 $4G/5G$ 数据，家里的 $WiFi$，蓝牙耳机等等。

---

**【阅读第七章之前：一点小小的“剧透”与学习导航】**

朋友，在我们正式启程探索无线与移动网络的奥秘之前，我想先给你一些“剧透”和导航，帮助你更好地把握本章的脉络。

你可能会问，无线网络和我们之前学习的传统有线网络（比如以太网）有什么本质的不同呢？除了“线”变成了“空气”，还有哪些核心挑战呢？

本章将围绕两大核心主题展开：

1.  **无线 (Wireless) 的特性与挑战** 📡：
    *   **不靠谱的信道**：无线信道不像光纤或铜线那样稳定。信号会衰减、会受到各种干扰（其他无线设备、微波炉等）、还会因为多径传播（信号从不同路径到达）而变得复杂。我们将探讨这些现象如何影响数据传输，以及如何量化链路质量（如 $SNR$）。
    *   **共享天空的“礼仪”**：有线网络中，设备接入交换机，冲突检测相对容易。但在无线环境中，大家共享开放的无线媒介，如何有效协调，避免“抢话筒”（冲突），是一个大问题。我们将学习 $CSMA/CA$（载波侦听多路访问/冲突避免）这样的“对话规则”。
    *   **“听不见你”的尴尬**：无线网络中存在“隐藏终端”问题——$A$ 和 $C$ 都想和 $B$ 通信，但 $A$ 和 $C$ 互相听不见对方，它们同时发送数据给 $B$ 就会造成冲突。我们将看到 $RTS/CTS$ 机制如何尝试解决这个问题。

2.  **移动性 (Mobility) 的管理难题** 🚶‍♀️📱：
    *   **永不“失联”的追求**：当你拿着手机从一个 $WiFi$ 热点走到另一个，或者在高速列车上从一个基站覆盖区进入另一个基站覆盖区时，你的网络连接是如何保持不中断的？这就是移动性管理要解决的核心问题。
    *   **“家”在哪里的哲学**：为了让别人能随时找到你（的网络设备），你需要一个相对固定的“家庭住址”（家乡网络）。当你漫游到其他地方（拜访网络）时，家乡网络需要知道你的新位置，以便将数据正确地转发给你。我们将探讨间接路由和直接路由的策略。
    *   **从 $WiFi$ 到 $4G/5G$**：我们将具体分析 $WiFi$ 网络中的移动性，以及更复杂的蜂窝网络（如 $4G$ $LTE$）是如何通过精心设计的架构（包括 $MME, S-GW, P-GW, HSS$ 等组件）来实现无缝移动和切换的。

所以，当你看到诸如信号衰减、信噪比 ($SNR$)、隐藏终端、$CSMA/CA$、$MME$、$HSS$、切换 (handover) 等概念时，请记住，它们都是为了克服无线链路的不可靠性，以及实现用户在移动过程中的持续连接。

带着这两个核心主题——“无线本身的挑战”和“移动带来的管理复杂度”——我相信你会更容易理解本章的各个知识点。

祝你学习愉快，一起揭开无线与移动网络的神秘面纱！🚀

---

### 1. 引言：无线与移动的时代 🌊

我们正处在一个无线连接无处不在、移动设备高度普及的时代。

*   **数据说话** 📊：
    *   全球移动电话用户数量远超固定电话用户（例如，在2019年可能达到10:1的比例！）。
    *   通过移动宽带连接的设备数量也远超固定宽带连接的设备（例如，在2019年可能达到5:1的比例！）。
    *   $4G/5G$ 蜂窝网络越来越多地拥抱互联网协议栈，包括 $SDN$ (软件定义网络) 等先进理念。

在这样的背景下，理解无线与移动网络的工作原理至关重要。本章主要关注两大挑战：

1.  **无线 (Wireless)** 📡：指通过无线链路进行的通信。这本身就带来了许多与有线通信不同的问题。
2.  **移动性 (Mobility)** 🏃：指处理移动用户在网络中改变接入点（Point of Attachment）的情况，如何保持通信的连续性。

#### 1.1 无线网络的基本构成元素 🧱

一个典型的无线网络通常包含以下元素：

*   **无线主机 (Wireless Hosts)** 💻📱：
    *   如笔记本电脑、智能手机、物联网 ($IoT$) 设备等。
    *   它们运行各种应用程序。
    *   它们可能是**静止的 (stationary)**，也可能是**可移动的 (mobile)**。
    *   $\boxed{ \text{无线不一定意味着移动性！} }$ 例如，台式机通过 $WiFi$ 连接到网络，它就是无线的，但通常不是移动的。
*   **基站 (Base Station)** 🗼：
    *   通常连接到有线网络基础设施。
    *   扮演“中继”角色，负责在其覆盖区域内（通常称为一个“小区”或“cell”）的无线主机与有线网络之间转发数据包。
    *   例如：蜂窝网络中的**蜂窝塔 (Cell Towers)**， $WiFi$ 网络中的**接入点 (Access Points, AP)**。
*   **无线链路 (Wireless Link)** 〰️：
    *   用于连接移动设备到基站，或者在某些情况下作为骨干链路。
    *   由于多个用户可能共享同一无线链路，需要**多路访问协议 (Multiple Access Protocol)** 来协调链路的访问。
    *   无线链路具有不同的传输速率、覆盖距离和使用的频段。

#### 1.2 无线网络的两种工作模式 ✌️

1.  **基础设施模式 (Infrastructure Mode)**：
    *   这是最常见的模式。无线主机通过基站连接到更大的有线网络（如互联网）。
    *   **切换 (Handoff / Handover)**：当一个移动主机从一个基站的覆盖范围移动到另一个基站的覆盖范围时，其网络连接从旧基站“切换”到新基站的过程。这是实现移动性的关键。
2.  **自组织模式 (Ad hoc Mode)**：
    *   没有预设的基站。
    *   节点（主机）之间直接通信，前提是它们在彼此的无线覆盖范围内。
    *   节点可以自行组织成一个网络，并在它们之间进行路由。例如，蓝牙设备间临时组网，或在没有网络设施的紧急情况下设备间的通信。
    * ![](Pic/Pasted%20image%2020250529193334.png)

#### 1.3 无线网络分类概览 🗺️
	
| 特性             | 单跳 (Single Hop)                                                                 | 多跳 (Multiple Hops)                                                                                                |
| :--------------- | :-------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------- |
| **有基础设施**   | 主机连接到基站（如 $WiFi$ AP、蜂窝基站），基站再连接到更大的互联网。                 | 主机可能需要通过其他无线节点进行中继，才能连接到远处的基站或互联网。这类网络有时被称为**无线网状网 (Wireless Mesh Network)**。 |
| **无基础设施**   | 节点间直接通信，无需基站，不一定连接到更大的互联网（如蓝牙、Ad hoc 模式的 $WiFi$）。 | 节点间自行组网，数据通过多跳转发。例如**移动自组织网络 (MANET, Mobile Ad hoc Network)** 或**车载自组织网络 (VANET)**。     |

### 2. 无线链路与网络特性：与有线世界的“代沟” 🤔

无线链路与我们熟悉的有线链路（如双绞线、光纤）相比，存在显著差异，这些差异给网络设计带来了新的挑战。

#### 2.1 无线链路的“三大难” 🤕

1.  **信号强度衰减** 📉：
    *   无线电信号在传播过程中，其强度会随着距离的增加以及穿过障碍物（如墙壁、人体）而显著减弱。这被称为**路径损耗 (Path Loss)**。
    *   这意味着信号覆盖范围有限，且信号质量不稳定。
2.  **来自其他源的干扰** 💥：
    *   许多无线设备共享相同的频段（例如，$2.4 GHz$ 频段被 $WiFi$、蓝牙、微波炉、无绳电话等共享）。
    *   这些设备发出的信号会相互干扰，导致数据传输错误。
3.  **多径传播** 🔄：
    *   无线电信号并不仅仅沿着直线从发送方传播到接收方。它还会被地面、建筑物、物体等反射、衍射和散射，从而产生多个版本的信号副本，它们沿着不同的路径、在略微不同的时间到达接收方。
    *   这些多径信号可能相互叠加，导致信号增强或减弱（**衰落现象，Fading**），甚至造成**码间干扰 (Inter-Symbol Interference, ISI)**，即前一个符号的“拖尾”干扰到后一个符号的判决。
$$\boxed{ \text{这些因素使得无线链路上的通信（即使是点对点）也比有线链路困难得多。} }$$

#### 2.2 衡量链路质量：$SNR$ 与 $BER$ ⚖️

*   **信噪比 ($SNR$, Signal-to-Noise Ratio)**:
    *   衡量的是接收到的有用信号功率与噪声功率的比值。
    *   通常用分贝 ($dB$) 表示：$SNR_{dB} = 10 \log_{10} (P_{signal} / P_{noise})$。
    *   $\boxed{ \text{更高的 } SNR \text{ 意味着更容易从噪声中提取出有用信号，是“好事”。} }$
*   **误码率 ($BER$, Bit Error Rate)**:
    *   衡量的是传输的比特中出现错误的比例。
    *   $BER$ 通常与 $SNR$ 相关：$SNR$ 越高，$BER$ 往往越低。
*   **$SNR$ 与 $BER$ 的权衡与自适应**：
    *   **给定物理层参数 (如调制方式)**：增加发送功率可以提高 $SNR$，从而降低 $BER$。
    *   **给定 $SNR$ 条件**: 网络设备可以选择不同的物理层参数（如不同的调制编码方案 - MCS）来在吞吐量和鲁棒性之间取得平衡。
        *   例如，在 $SNR$ 较高时，可以使用更高级的调制方式（如 $256-QAM$），实现更高的吞吐量。
        *   当 $SNR$ 下降（如用户远离基站），设备可以动态切换到更鲁棒但速率较低的调制方式（如 $BPSK$），以维持连接并保证可接受的 $BER$。这种动态调整称为**链路自适应 (Link Adaptation)** 或**速率自适应 (Rate Adaptation)**。
        ![](Pic/Pasted%20image%2020250529203018.png)
        (图解：不同调制方式下 $BER$ 随 $SNR$ 变化的典型曲线，越高阶的调制（如$QAM256$）在相同$BER$下需要更高的$SNR$，但能提供更高的数据速率)

#### 2.3 无线网络中的“老大难”：隐藏终端与暴露终端问题 🙈🙉

当多个无线发送方和接收方共享介质时，会出现一些有线网络中不存在或不那么突出的问题。

*   **隐藏终端问题**：
    *   场景：假设有三个节点 $A, B, C$。$A$ 和 $C$ 都在 $B$ 的通信范围内，但 $A$ 和 $C$ 互相听不到对方（可能因为距离远或有障碍物）。
    *   问题：如果 $A$ 和 $C$ 同时向 $B$ 发送数据，它们的信号会在 $B$ 处碰撞，导致 $B$ 无法正确接收任何一个信号。然而，$A$ 和 $C$ 因为听不到对方，会以为信道是空闲的，从而继续发送。
    *   **为什么 $CSMA/CD$ (载波侦听多路访问/冲突检测) 在这里不好用？**
        *   $CD$（冲突检测）在无线环境中很难实现。发送方自身的信号功率远大于可能接收到的其他微弱信号，很难在发送的同时可靠地检测到微弱的碰撞信号。
        *   即使能检测，也无法解决所有隐藏终端问题，因为冲突发生在远端接收方，发送方可能根本感知不到。
![](Pic/Pasted%20image%2020250529203644.png)
*   **信号衰减导致的问题 (Fading/Attenuation Problem - 与暴露终端相关)**：
    *   虽然这不是一个独立的问题，但它加剧了隐藏终端问题，并可能导致“暴露终端问题”。
    *   暴露终端问题 (Exposed Terminal Problem)：节点 $B$ 正在向 $A$ 发送数据。节点 $C$ 想要向 $D$ 发送数据。$C$ 听到了 $B$ 的发送，于是认为信道忙，推迟发送。但实际上，$C$ 向 $D$ 的发送可能并不会干扰 $A$ 接收 $B$ 的信号（因为 $C$ 离 $A$ 很远，或 $D$ 离 $B$ 很远）。这导致了不必要的等待，降低了信道利用率。

这些问题促使无线网络采用不同于以太网的介质访问控制方法。

#### 2.4 码分多址 ($CDMA$) 简介 🎶 

*   在某些无线系统（尤其是早期的 $2G/3G$ 蜂窝网络）中，使用 $CDMA$ (Code Division Multiple Access)允许多个用户同时使用相同的频段。
*   **核心思想**：为每个用户分配一个独特的“码片序列” (chipping sequence)，这个码片序列是伪随机的。
    *   **编码**: 发送数据时，用户的数据比特流与这个码片序列进行特定的运算（如异或或乘法），将原始的窄带信号扩展成宽带信号。
    *   **多用户共享**: 所有用户的扩展后信号在同一频段叠加。
    *   **解码**: 接收端使用与目标用户相同的码片序列对接收到的混合信号进行相关运算。由于码片序列设计时具有良好的**正交性** (或准正交性)，接收机可以从混合信号中恢复出特定用户的原始数据，而其他用户的信号则表现为噪声。
        *   如果码是理想正交的，那么一个用户的码与另一个用户的码进行相关运算结果为0。
*   **优点**:
    *   天然的抗干扰能力（扩频通信的特性）。
    *   软容量：用户数量增加时，系统性能平缓下降，而不是硬性限制。
    *   无需精确的时间同步（相对于 $TDMA$）。

    ![](Pic/Pasted%20image%2020250529212805.png)
    (图解：$CDMA$ 中两个发送者 $S_1, S_2$ 使用不同码片 $c_1, c_2$ 发送数据 $d_1, d_2$。信号在信道中叠加。接收者使用 $c_1$ 解码可以恢复 $d_1$)

    **注意**：虽然 $CDMA$ 是一个重要的多址技术，但在现代 $WiFi (802.11)$ 和 $4G/5G$ 蜂窝网络中，主要采用的是 $OFDMA$ (Orthogonal Frequency Division Multiple Access) 或其变体，它结合了频分多址和时分多址的思想。
### 3. WiFi：$IEEE$ $802.11$ 无线局域网 💻🌐

$IEEE$ $802.11$ 系列标准，俗称 $WiFi$，是我们日常生活中最常接触到的无线网络技术之一。它定义了无线局域网 ($WLAN$) 的物理层和介质访问控制 (MAC) 子层规范。

#### 3.1 $802.11$ 标准家族与演进 📈

$802.11$ 标准不断发展，以提供更高的数据速率、更好的性能和更多的功能。

| $IEEE$ $802.11$ 标准  | 发布年份 (约)    | 最大数据速率        | 典型范围   | 频段                      |
| :------------------ | :---------- | :------------ | :----- | :---------------------- |
| $802.11b$           | 1999        | $11 Mbps$     | $30 m$ | $2.4 GHz$               |
| $802.11g$           | 2003        | $54 Mbps$     | $30 m$ | $2.4 GHz$               |
| $802.11n$ (WiFi 4)  | 2009        | $600 Mbps$    | $70 m$ | $2.4, 5 GHz$            |
| $802.11ac$ (WiFi 5) | 2013        | $3.47 Gbps$   | $70 m$ | $5 GHz$                 |
| $802.11ax$ (WiFi 6) | 2020 (exp.) | $14 Gbps$     | $70 m$ | $2.4, 5 GHz$            |
| $802.11af$          | 2014        | $35-560 Mbps$ | $1 Km$ | 未使用的电视频段 ($54-790 MHz$) |
| $802.11ah$ (HaLow)  | 2017        | $347 Mbps$    | $1 Km$ | $900 MHz$               |

*   **关键共性**：
    *   所有这些标准都使用 $CSMA/CA$ 作为多路访问机制。
    *   它们都支持基础设施模式（通过AP）和自组织模式（ad-hoc）。

#### 3.2 $802.11$ 网络架构 🏗️

*   **基本服务集 ($BSS$, Basic Service Set)**：
    *   在**基础设施模式**下，一个 $BSS$ 由一个**接入点 ($AP$, Access Point)** 和若干与之关联的无线主机组成。这个 $AP$ 通常连接到一个有线网络（如交换机或路由器），从而将无线主机接入更大的网络。$AP$ 扮演着基站的角色。
    *   在**自组织模式 (Ad hoc mode)** 下，$BSS$ 由一组直接相互通信的无线主机组成，没有 $AP$。
    *   可以把一个 $BSS$ 想象成一个“小区 (cell)”。
        ![](Pic/Pasted%20image%2020250529231950.png)
        (图解：两个 $BSS$，每个 $BSS$ 有一个 $AP$ 连接到互联网的交换机/路由器。$BSS1$ 和 $BSS2$ 中的主机分别与各自的 $AP$ 通信。)

#### 3.3 $802.11$ 的信道与关联 📡🔗

*   **频谱与信道划分**：
    *   $802.11$ 标准在特定的频段（如 $2.4 GHz, 5 GHz$）工作，这些频段被划分为多个**信道 (Channels)**。
    *   $AP$ 的管理员需要为其 $AP$ 选择一个工作信道。
    *   **干扰问题**：如果相邻的 $AP$ 使用相同或重叠的信道，它们之间可能会产生干扰，影响性能。例如，在 $2.4 GHz$ 频段，通常推荐使用信道 $1, 6, 11$ 来避免重叠。
*   **关联 (Association)**：
    *   当一个无线主机（如笔记本电脑）进入一个 $AP$ 的覆盖范围并希望接入网络时，它必须首先与该 $AP$ **关联**。
    *   关联过程通常包括：
        1.  **扫描 (Scanning)**：主机扫描可用的 $AP$。
            *   **被动扫描 (Passive Scanning)**：主机侦听来自 $AP$ 的**信标帧 (Beacon Frames)**。信标帧由 $AP$ 定期广播，包含了 $AP$ 的名称 ($SSID$, Service Set Identifier)、MAC地址、支持的速率、安全配置等信息。
            *   **主动扫描 (Active Scanning)**：主机广播一个**探测请求帧 (Probe Request Frame)**。附近的 $AP$ 收到后会回复一个**探测响应帧 (Probe Response Frame)**，包含类似信标帧的信息。
        2.  **选择 $AP$**：主机根据接收到的信标帧或探测响应帧（例如信号强度、负载情况、安全策略等）选择一个 $AP$ 进行关联。
        3.  **身份验证 (Authentication)** (可选但常见)：在关联之前或之后，可能需要进行身份验证（例如输入 $WPA2/WPA3$ 密码）。这部分内容更详细的会在网络安全章节讨论（如第8章）。
        4.  **关联请求/响应**：主机向选定的 $AP$ 发送**关联请求帧 (Association Request Frame)**。如果 $AP$ 同意，则回复**关联响应帧 (Association Response Frame)**。
        5.  **$DHCP$**：关联成功后，主机通常会通过 $DHCP$ (Dynamic Host Configuration Protocol) 从网络获取 $IP$ 地址、子网掩码、网关地址和 $DNS$ 服务器地址。
        ![](Pic/Pasted%20image%2020250529232254.png)
        (图解：被动扫描与主动扫描流程示意图。被动：$AP$ 发信标，$H1$ 接收，然后 $H1$ 发关联请求，$AP$ 回复关联响应。主动：$H1$ 广播探测请求，$AP$ 回复探测响应，$H1$ 选择 $AP$ 发关联请求，$AP$ 回复关联响应。)

#### 3.4 $802.11$ 介质访问控制：$CSMA/CA$ 🚦

我们已经知道，无线网络中存在隐藏终端问题，且冲突检测 ($CD$) 难以实现。因此，$802.11$ 采用 $CSMA/CA$ (载波侦听多路访问/冲突避免) 机制。

*   **目标**：不是检测和处理已经发生的冲突，而是**尽量避免冲突的发生**。
*   **$CSMA/CA$ 基本流程**：
    1.  **侦听信道 (Carrier Sense)**：
        *   如果信道空闲了一段称为 $DIFS$ (Distributed Inter-Frame Space，分布式帧间间隔) 的时间，发送方就可以准备发送。
        *   如果信道忙，发送方就必须等待。
    2.  **随机退避 (Random Backoff)**：
        *   即使信道在 $DIFS$ 后变为空闲，发送方也不会立即发送（因为可能有其他节点也同时认为信道空闲）。
        *   它会选择一个随机的**退避时间 (Backoff Time)**。这个时间是从一个**竞争窗口 (Contention Window, $CW$)** 中随机选取的。
        *   发送方会持续侦听信道。只有当信道保持空闲时，退避计时器才会递减。如果信道在退避过程中变忙，计时器会暂停，直到信道再次空闲并经过 $DIFS$ 后才继续递减。
        *   当退避计时器减到零时，发送方才发送整个数据帧。
    3.  **确认 ($ACK$)**：
        *   由于无线信道不可靠，接收方成功接收数据帧后，会等待一个很短的 $SIFS$ (Short Inter-Frame Space，短帧间间隔，比 $DIFS$ 短，优先级更高) 时间后，回复一个**确认帧 ($ACK$ Frame)**。
        *   如果发送方在规定时间内没有收到 $ACK$，则认为发生了冲突或数据丢失。它会**增加竞争窗口的大小**（通常是加倍，称为**二进制指数退避 Binary Exponential Backoff, $BEB$**），然后重新进入随机退避过程，尝试重传。
        *   $ACK$ 机制对于处理因隐藏终端导致的冲突（虽然不能完全避免）或一般的传输错误至关重要。
        ![](Pic/Pasted%20image%2020250529232827.png)
        (图解：$CSMA/CA$ 时序图。发送方等待 $DIFS$，然后进行随机退避。发送数据后，接收方等待 $SIFS$ 回复 $ACK$。)

#### 3.5 进一步避免冲突：$RTS/CTS$ 机制 (可选) 🗣️👂

即使有了 $CSMA/CA$，$ACK$ 和指数退避，隐藏终端问题仍然可能导致冲突，尤其是在传输长数据帧时，冲突的代价更大。为了进一步缓解这个问题，$802.11$ 引入了可选的 $RTS/CTS$ (Request to Send / Clear to Send，请求发送/清除发送) 握手机制。
*   **适用场景**：通常用于发送较长的数据帧时（有一个可配置的门限值，超过此长度的帧才使用 $RTS/CTS$）。对于短帧，直接发送可能更高效，因为 $RTS/CTS$ 本身也有开销。
*   **$RTS/CTS$ 交换过程**：
    1.  **$RTS$ (请求发送)**：想要发送数据的节点 $A$ (在完成 $CSMA/CA$ 的退避后) 先向接收节点 $B$ (通常是 $AP$) 发送一个短的 $RTS$ 帧。$RTS$ 帧中包含了本次通信预计需要持续的时间 (包括数据帧和 $ACK$ 帧)。
    2.  **$CTS$ (清除发送)**：如果 $B$ 同意 $A$ 发送，它会回复一个短的 $CTS$ 帧。$CTS$ 帧也包含了通信预计的持续时间。
    3.  **$NAV$ (网络分配向量, Network Allocation Vector)**：
        *   所有能听到 $RTS$ 或 $CTS$ 的其他节点（即使它们听不到 $A$ 或 $B$ 的全部通信），都会根据 $RTS/CTS$ 帧中的持续时间信息，设置自己的 $NAV$ 计时器。
        *   在 $NAV$ 计时器倒计时结束前，这些节点会认为介质是“虚拟忙碌”的，即使物理载波可能是空闲的，它们也不会尝试发送数据，从而避免了冲突。
    4.  **数据发送与确认**：$A$ 收到 $CTS$ 后，就可以发送其数据帧。$B$ 收到数据后，回复 $ACK$。
*   **$RTS/CTS$ 如何帮助解决隐藏终端问题**：
	    *   考虑隐藏终端场景：$A$ 和 $C$ 都想发给 $B$，但 $A,C$ 互不可见。
    *   如果 $A$ 先发送 $RTS$ 给 $B$，$B$ 回复 $CTS$。节点 $C$ 即使听不到 $A$ 的 $RTS$，但它能听到 $B$ 的 $CTS$。$C$ 就会根据 $CTS$ 中的信息设置 $NAV$，在 $A$ 与 $B$ 通信期间保持沉默，从而避免了与 $A$ 的数据帧在 $B$ 处发生冲突。
    *   **注意**：$RTS$ 帧本身仍然可能发生冲突 (例如，两个隐藏终端同时向同一个 $AP$ 发送 $RTS$)。但因为 $RTS$ 帧很短，冲突的代价远小于长数据帧的冲突。
        ![](Pic/Pasted%20image%2020250529234049.png)

#### 3.6 $802.11$ 帧：不止一个地址的故事 💌

以太网帧通常有两个 MAC 地址：源 MAC 和目标 MAC。但 $802.11$ 帧（尤其是在基础设施模式下与 $AP$ 交互时）可能需要处理更复杂的地址场景，因此其帧格式中最多可以包含**四个地址字段**。

*   **$802.11$ 帧结构概览** (重要字段)：
* ![](Pic/Pasted%20image%2020250529235812.png)
* ![](Pic/Pasted%20image%2020250529234220.png)

*   **地址字段的含义 (取决于帧控制字段中的 To AP / From AP 位)**：
    *   **To AP**: 标记该帧是否发往 $AP$ (进而可能发往有线网络)。
    *   **From AP**: 标记该帧是否来自 $AP$ (可能源自有线网络)。

*   **其他重要字段**：
    *   **帧控制 (Frame Control)**：包含帧类型 (数据、控制如 $RTS/CTS/ACK$、管理如信标/探测)、To AP/From AP 位、WEP加密位 (已弃用)、帧分片信息等。
        *   **Type 和 Subtype 子字段**：共同决定了帧的具体类型，例如是 $RTS$ 帧、$CTS$ 帧、$ACK$ 帧、数据帧，还是信标帧等。
    *   **持续时间/ID (Duration/ID)**：在数据帧和管理帧中，通常用于 $NAV$ 计算，指示信道将被占用的时间。在控制帧中可能有其他含义。
    *   **序列控制 (Sequence Control)**：包含一个序列号和一个分片号，用于重传检测和对大数据帧进行分片和重组。

#### 3.7 $802.11$：同一子网内的移动性 🚶‍♂️➡️🚶‍♀️

当一个无线主机在同一个 $IP$ 子网内，从一个 $AP$ 的覆盖范围移动到另一个 $AP$ 的覆盖范围时（假设这两个 $AP$ 都连接到同一个交换机或路由器），会发生什么？

*   **$IP$ 地址保持不变**：由于主机仍在同一个 $IP$ 子网内，其 $IP$ 地址不需要改变。这对上层应用是透明的。
*   **交换机的角色 (回顾)**：
    *   交换机通过**自学习 (self-learning)** 维护一个 MAC 地址表，记录了哪个 MAC 地址可以通过哪个端口到达。
    *   当主机 $H1$ 从 $AP1$ 切换到 $AP2$ 时：
        1.  $H1$ 与 $AP2$ 完成新的关联过程。
        2.  $H1$ 可能会发送一个帧（例如 $DHCP$ 请求，或任何其他出站流量）通过 $AP2$。
        3.  当这个帧到达交换机时，交换机观察到源 MAC 地址 $H1$ 现在是从连接 $AP2$ 的端口到达的。
        4.  交换机**更新其 MAC 地址表**，将 $H1$ 的条目指向新的端口。
        5.  之后，发往 $H1$ 的帧就会被交换机正确地转发到连接 $AP2$ 的端口。
    *   这个过程对 $H1$ 和网络的其他部分是自动且相对快速的。

#### 3.8 $802.11$ 高级功能 ✨

*   **速率自适应 (Rate Adaptation)**：
    *   基站 ($AP$) 和移动设备会根据当前的信道条件（通常通过测量 $SNR$ 或 $BER$）动态地改变物理层的传输速率（即调制和编码方案, $MCS$）。
    *   当信道条件好 ($SNR$ 高) 时，使用高速率 $MCS$。
    *   当信道条件差 ($SNR$ 低，例如设备远离 $AP$ 或干扰增加) 时，切换到低速率但更鲁棒的 $MCS$，以降低 $BER$，维持连接。

*   **电源管理 (Power Management)** 🔋：
    *   为了延长移动设备的电池寿命，$802.11$ 允许设备进入**睡眠模式 (Sleep Mode)**。
    *   **工作流程**：
        1.  节点通知 $AP$ 它要进入睡眠模式：“我准备睡到下一个信标帧时刻”。
        2.  $AP$ 在此期间不会向该节点发送数据帧，而是将它们**缓冲 (buffer)** 起来。
        3.  $AP$ 在每个信标帧中会包含一个**流量指示图 ($TIM$, Traffic Indication Map)**，列出了哪些处于睡眠模式的节点有数据等待它们。
        4.  节点在预定的信标帧时刻醒来，接收信标帧，检查 $TIM$。
        5.  如果 $TIM$ 指示有数据给它，节点会保持唤醒状态，并向 $AP$ 发送一个 $PS-Poll$ (Power Save Poll) 帧来取回数据。
        6.  如果没有数据给它，节点可以再次进入睡眠模式，直到下一个信标帧。

#### 3.9 个人区域网络 ($PAN$)：蓝牙 (Bluetooth) 🎧📱🖱️

虽然不是 $802.11$ 系列，但蓝牙是另一种非常流行的短距离无线技术，用于构建个人区域网络 ($PAN$)。

*   **特点**：
    *   **短距离**：通常小于 $10$ 米。
    *   **低功耗**：设计目标之一。
    *   **用途**：替代线缆，连接外设（如鼠标、键盘、耳机）、设备间数据同步、可穿戴设备等。
    *   **工作模式**：通常是自组织 (ad hoc) 模式，无需基础设施。
    *   **频段**：工作在 $2.4 GHz$ $ISM$ (Industrial, Scientific, Medical) 频段，与 $WiFi$ 和微波炉等共享，可能会有干扰。
    *   **速率**：早期版本速率较低 (如 $1-3 Mbps$)，蓝牙 $5.x$ 及更高版本速率有显著提升。
*   **网络结构 (Piconet)**：
    *   一个蓝牙网络称为**微微网 (Piconet)**，由一个**主设备 (Master)** 和最多七个**从设备 (Slaves)** 组成。
    *   主设备控制微微网内的通信，决定哪个从设备何时可以发送。主设备会轮询从设备，授予它们发送数据的权限。
    *   **组网 (Bootstrapping)**：设备通过发现和配对过程自动组建微微网（即插即用）。
*   **多路访问与跳频**：
    *   **$TDM$ (时分复用)**：主从设备在预先分配的时隙中通信。一个时隙通常为 $625 \mu s$。
    *   **$FDM$ (频分复用) / 跳频扩频 ($FHSS$, Frequency Hopping Spread Spectrum)**：为了对抗干扰和提高安全性，蓝牙在 $79$ 个 (或 $40$ 个，取决于版本和地区) 不同的频道上以伪随机的顺序快速跳跃 (每秒 $1600$ 次)。发送方和接收方使用相同的跳频序列同步跳跃。
        *   如果其他设备（如 $WiFi$) 干扰了某个频道，蓝牙通信只会在该频道跳到时受到短暂影响。
*   **休眠模式 (Parked Mode)**：从设备可以进入休眠状态以节省电量，并在需要时被主设备唤醒。

---

### 4. 蜂窝网络：$4G$ 与 $5G$ 的宏大世界 📱🗼🌍

蜂窝网络（如我们熟知的 $4G$ $LTE$ 和新兴的 $5G$）是广域移动互联网的主要解决方案。

#### 4.1 蜂窝网络的特点与演进 🌟

*   **广泛部署与使用**：
    *   移动宽带连接设备远超固定宽带。
    *   $4G$ 网络覆盖率高（例如，韩国 $97\%$，美国 $90\%$ 的时间可用 $4G$）。
    *   传输速率可达数百 $Mbps$。
*   **标准化组织**：主要由 $3GPP$ (3rd Generation Partnership Project) 负责制定技术标准。
    *   官网：www.3gpp.org
    *   $4G$ 的主要标准是 $LTE$ (Long-Term Evolution)。
*   **与有线互联网的异同**：
    *   **相似之处**：
        *   存在**边缘/核心**的网络结构划分（尽管都在运营商内部）。
        *   全球蜂窝网络本身也是一个“网络的网络”。
        *   广泛使用我们学过的协议：$HTTP, DNS, TCP, UDP, IP, NAT$。
        *   数据平面与控制平面分离的思想，$SDN$ 概念的引入。
        *   通过隧道技术实现连接，并与有线互联网互联。
    *   **不同之处**：
        *   **无线链路层**：采用专门为蜂窝环境优化的无线技术。
        *   **移动性作为一等公民**：整个架构为支持大规模、高速移动性而设计。
        *   **用户身份 ($SIM$ 卡)**：通过 $SIM$ (Subscriber Identity Module) 卡唯一标识用户及其服务。
        *   **商业模式**：用户通常向蜂窝运营商订阅服务计划。
        *   **家乡网络 vs. 拜访网络 (Home vs. Visited Network)**：有强烈的归属网络概念，支持用户在其他运营商网络中漫游。
        *   **全球接入与认证**：有复杂的认证基础设施和运营商间的结算机制。

#### 4.2 $4G$ $LTE$ 架构概览：组件与功能 🧩

$4G$ $LTE$ 网络架构主要由以下几部分组成：

![](Pic/Pasted%20image%2020250530002426.png)
(图解：$4G$ $LTE$ 简化架构图。包含 $UE$, $eNodeB$, $MME$, $S-GW$, $P-GW$, $HSS$，以及它们如何连接到无线接入网和核心网 ($EPC$))。

*   **用户设备 ($UE$, User Equipment)** 📱：
    *   智能手机、平板电脑、物联网设备等，内置 $4G$ $LTE$ 无线模块。
    *   包含一个 $SIM$ 卡，存储着 $64$ 位的**国际移动用户识别码 ($IMSI$, International Mobile Subscriber Identity)**，用于唯一标识用户。
    *   $LTE$ 术语中常直接称为 $UE$。
*   **演进型基站 ($eNodeB$, Evolved NodeB)** 🗼：
    *   位于运营商网络的“边缘”。
    *   管理其覆盖小区 (cell) 内的无线资源和 $UE$。
    *   协调 $UE$ 的认证、与核心网的连接、以及移动性管理（如切换）。
    *   与 $WiFi$ $AP$ 类似，但功能更复杂，并主动参与用户移动性管理，协调相邻基站以优化无线资源使用。
    *   $LTE$ 术语。
*   **移动性管理实体 ($MME$, Mobility Management Entity)** 🧠：
    *   **控制平面核心组件**。
    *   **设备认证**：与 $HSS$ 协作，对 $UE$ 进行认证（设备到网络，网络到设备）。
    *   **移动设备管理**：
        *   处理 $UE$ 在不同 $eNodeB$ 之间的切换 (handover)。
        *   跟踪/寻呼 $UE$ 的位置（以便在有数据到达时找到它）。
    *   **路径建立**：负责建立从 $UE$ 到 $P-GW$ 的数据传输路径（隧道）。
*   **服务网关 ($S-GW$, Serving Gateway)**  Datenautobahn 🚗：
    *   **数据平面组件**。
    *   位于从 $UE$ 到/来自互联网的数据路径上。
    *   在 $eNodeB$ 之间切换时，作为 $UE$ 数据路径的本地锚点，确保数据流的连续性。
    *   负责在 $eNodeB$ 和 $P-GW$ 之间转发用户数据。
*   **$PDN$ 网关 ($P-GW$, Packet Data Network Gateway)** 🚪：
    *   **数据平面组件**，也是 $UE$ 的 $IP$ 地址分配点。
    *   作为 $UE$ 访问外部分组数据网络 (如互联网) 的网关。
    *   类似于传统网络的网关路由器，可能执行 $NAT$、策略执行、计费等功能。
    *   在 $UE$ 漫游时，通常仍通过其家乡网络的 $P-GW$ 访问互联网（除非有本地疏导策略）。
*   **归属签约用户服务器 ($HSS$, Home Subscriber Server)** 📇：
    *   **控制平面核心数据库**。
    *   存储关于签约用户的信息，包括：
        *   $IMSI$。
        *   用户的服务配置、签约的服务等级 ($QoS$ 参数)。
        *   用户的加密和认证密钥。
        *   **当前位置信息** (例如，用户当前在哪个 $MME$ 的管理之下)。
    *   当 $UE$ 尝试接入网络时，$MME$ 会查询 $HSS$ 以获取用户信息并进行认证。
*   **演进的分组核心网 ($EPC$, Evolved Packet Core)**：由 $MME, S-GW, P-GW, HSS$ 等共同构成 $LTE$ 的核心网络。它是一个**全 $IP$ (all-IP)** 的网络。

#### 4.3 $LTE$：数据平面与控制平面分离 ↔️

$LTE$ 架构清晰地体现了数据平面和控制平面的分离：

*   **控制平面 (Control Plane)**：
    *   涉及信令消息，用于网络管理、用户认证、移动性管理、连接建立与拆除等。
    *   主要由 $MME$ 和 $HSS$ 处理，以及 $eNodeB$ 的控制功能部分。
    *   使用新的协议进行移动性管理、安全认证等。
        ![](Pic/Pasted%20image%2020250530003322.png)
		 (控制平面交互示意图：$UE \leftrightarrow eNodeB \leftrightarrow MME \leftrightarrow HSS; MME \leftrightarrow S-GW/P-GW$)
*   **数据平面 (Data Plane)**：
    *   负责实际用户数据的传输。
    *   在链路层和物理层有新的协议。
    *   广泛使用**隧道技术 (Tunneling)** (例如 $GTP$ 隧道) 来支持移动性，确保 $UE$ 在移动时其 $IP$ 地址可以保持不变，数据流可以被正确路由。
        ![](Pic/Pasted%20image%2020250530003412.png)
		 (数据平面交互示意图：$UE \leftrightarrow eNodeB \leftrightarrow S-GW \leftrightarrow P-GW$ 之间通过 $IP$ 隧道传输数据)

#### 4.4 $LTE$ 数据平面协议栈 📚

1.  **第一跳：$UE \leftrightarrow eNodeB$ (无线接入网 $RAN$ 部分)**
	    ![](Pic/Pasted%20image%2020250530003521.png) (LTE UE 与 eNodeB 间协议栈)

    *   **物理层 (Physical)**：负责实际的无线信号传输和接收。
    *   **介质访问控制 ($MAC$)**：负责调度 $UE$ 在共享无线信道上的传输时隙，请求和使用无线传输资源。
    *   **无线链路控制 ($RLC$, Radio Link Control)**：
        *   提供分段/重组功能，将大的 $IP$ 包分割成适合无线传输的小块。
        *   可以提供可靠数据传输（通过 $ARQ$ 机制，类似于 $TCP$ 的确认和重传）或不可靠传输，取决于业务需求。
    *   **分组数据汇聚协议 ($PDCP$, Packet Data Convergence Protocol)**：
        *   进行 $IP$ 头部压缩，以减少无线接口上的开销。
        *   提供加密功能，保护用户数据的机密性。
        *   在切换期间，负责数据的有序递交和去重。
    *   **$IP$ 层**：处理 $IP$ 数据包。
    *   **$LTE$ 无线接入网技术特点**：
        *   **下行链路 (基站到 $UE$)**: 通常采用 $OFDMA$ (Orthogonal Frequency Division Multiple Access，正交频分多路复用接入)。将宽带信道划分为大量窄带正交子载波，不同用户分配不同的子载波子集。$OFDM$ 技术能有效对抗多径衰落。
        *   **上行链路 ($UE$ 到基站)**: 通常采用 $SC-FDMA$ (Single Carrier Frequency Division Multiple Access，单载波频分多路复用接入)，它具有较低的峰均功率比 ($PAPR$)，对 $UE$ 的功耗更友好。
        *   **正交性**：子载波间的正交性确保了它们之间的干扰最小。
        *   每个活跃的 $UE$ 会被分配一个或多个时频资源块（例如，$0.5ms$ 的时隙和若干子载波）。
        *   调度算法（决定哪个 $UE$ 在何时使用哪些资源）不由标准规定，留给运营商和设备商实现，通常目标是最大化系统吞吐量、保证 $QoS$ 或实现公平性。
        *   单个 $UE$ 可以获得数百 $Mbps$ 的速率。

2.  **核心网内部：$EPC$ (分组核心网)**
    ![](Pic/Pasted%20image%2020250530003839.png) (LTE EPC 中 GTP 隧道示意图)

    *   **隧道技术 (Tunneling)** 是 $EPC$ 数据平面的核心。主要使用 $GTP$ (GPRS Tunneling Protocol)。
    *   **$GTP-U$ (用户平面 $GTP$)**: 用于封装和传输用户数据包。
        *   例如，从 $UE$ 发往互联网的数据包：
            1.  $UE \to eNodeB$ (无线链路)。
            2.  $eNodeB$ 将收到的 $IP$ 包封装在一个 $GTP$ 包中，该 $GTP$ 包再封装在一个新的 $IP$ 包 (外部 $IP$ 包) 和 $UDP$ 包中，发往 $S-GW$。($IP_{orig}(payload) \to GTP(IP_{orig}(payload)) \to UDP(GTP(...)) \to IP_{outer}(UDP(GTP(...)))$)
            3.  $S-GW$ 收到后，解封装，再用类似的方式封装并发往 $P-GW$。
            4.  $P-GW$ 解封装，得到原始 $IP$ 包，然后将其路由到互联网。
    *   **隧道的作用**：
        *   **移动性支持**：当 $UE$ 在 $eNodeB$ 间移动时，只需要改变隧道的端点 ($S-GW$ 不变，或 $S-GW$ 也可能改变但 $P-GW$ 作为锚点通常不变)，而 $UE$ 的 $IP$ 地址可以保持不变，上层连接 (如 $TCP$) 不受影响。
        *   **网络隔离与管理**：允许运营商在自己的 $IP$ 骨干网上承载多个用户的逻辑数据流。

#### 4.5 $LTE$：与基站的关联过程 (Attach) 🤝

当 $UE$ 开机或进入 $LTE$ 网络覆盖时，需要执行一个“附着 (Attach)”过程来注册到网络并建立数据连接。

1.  $UE$ 开机后，会扫描所有可用频段，寻找 $LTE$ 信号。它会侦听来自 $eNodeB$ 的**主同步信号 ($PSS$)** 和**辅同步信号 ($SSS$)**，这些信号每 $5ms$ 广播一次。$UE$ 通过这些信号与 $eNodeB$ 的下行链路实现时间和频率同步。
    *   可能有来自不同运营商的多个 $eNodeB$ 在广播同步信号。
2.  $UE$ 同步到一个 $eNodeB$ 后，会读取该 $eNodeB$ 广播的**系统信息块 ($SIB$)**。$SIB$ 包含了该小区的详细信息，如小区身份、频段、带宽、相邻小区列表、以及接入该小区所需的配置参数。
    *   $UE$ 可能会从多个 $eNodeB$ 获取信息。
3.  $UE$ 根据获取的信息（例如，优先选择归属运营商的 $eNodeB$，或信号最强的 $eNodeB$）选择一个 $eNodeB$ 进行附着。
4.  后续步骤涉及复杂的信令交互，包括：
    *   $UE$ 通过选定的 $eNodeB$ 向 $MME$ 发起**附着请求 (Attach Request)**，其中包含 $UE$ 的 $IMSI$。
    *   $MME$ 根据 $IMSI$ 查询 $HSS$，获取用户信息并进行**认证 (Authentication)** 和**密钥协商**。
    *   $MME$ 为 $UE$ 分配相关的网络资源，并通知 $S-GW$ 和 $P-GW$ **建立数据承载 (bearers)** (即前述的 $GTP$ 隧道)。
    *   $P-GW$ 为 $UE$ **分配 $IP$ 地址**。
    *   完成这些步骤后，$UE$ 成功附着到网络，数据平面也已建立，可以开始数据通信。

#### 4.6 $LTE$ 移动设备的睡眠模式 😴

与 $WiFi$ 类似，$LTE$ $UE$ 也可以进入睡眠模式以节省电池。

*   **浅度睡眠 (Light Sleep)**：在几百毫秒无活动后进入。
    *   $UE$ 会周期性地（例如每几百毫秒）短暂唤醒，检查是否有下行数据（通过寻呼信道）。
*   **深度睡眠 (Deep Sleep)**：在 $5-10$ 秒无活动后进入。
    *   唤醒周期更长。
    *   在深度睡眠期间，$UE$ 可能会改变其服务小区（例如，用户移动了）。如果发生这种情况，当 $UE$ 最终被唤醒或主动发起通信时，需要重新建立与新小区的关联（可能涉及简化的附着或切换流程）。

#### 4.7 全球蜂窝网络：IP 网络的网络 🌐

可以将全球蜂窝网络看作是一个由众多运营商的 $IP$ 网络互联而成的庞大系统。

*   **家乡网络 $HSS$ 的角色**：
    *   存储用户的身份信息、服务配置、以及漫游时的位置信息。
    *   当用户在拜访网络 (Visited Network) 中时，拜访网络的 $MME$ 会与用户的家乡网络 $HSS$ 通信，以验证用户身份并获取服务授权。
*   **全 $IP$ 的趋势**：
    *   $4G$ $LTE$ 及其核心网 $EPC$ 被设计为全 $IP$ 网络，语音业务也通过 $IP$ 承载 (如 $VoLTE$ - Voice over $LTE$)。
    *   运营商之间通过 $IPX$ (IP eXchange) 等网络互联，实现全球漫游和数据交换。
    *   公共互联网与蜂窝网络在多个点（如 $P-GW$）连接。
*   **传统网络的处理**：早期的 $2G, 3G$ 网络并非完全基于 $IP$，它们有专门的电路交换域处理语音，分组交换域处理数据。现代网络逐渐向全 $IP$ 演进。

#### 4.8 迈向 $5G$！🚀

$5G$ 是下一代蜂窝网络技术，旨在提供比 $4G$ 更高的性能和更多的能力。

*   **$5G$ 的目标**：
    *   峰值比特率提高 $10$ 倍 (可达 $10-20 Gbps$)。
    *   延迟降低 $10$ 倍 (目标 $1ms$ 左右的空口延迟)。
    *   网络容量（单位面积内可服务的用户数和总吞吐量）提高 $100$ 倍。
    *   支持三大应用场景：增强型移动宽带 ($eMBB$)、大规模机器类型通信 ($mMTC$)、超可靠低延迟通信 ($URLLC$)。
*   **$5G$ 新空口 ($NR$, New Radio)**：
    *   定义了新的无线接入技术。
    *   **双频段策略**：
        *   $FR1$ (Frequency Range 1)：$450 MHz - 6 GHz$ (Sub-6GHz 频段)。与 $4G$ 频段有重叠，提供广覆盖。
        *   $FR2$ (Frequency Range 2)：$24 GHz - 52 GHz$ (毫米波频段, $mmWave$)。提供极大带宽和高速率，但覆盖范围小，穿透能力差。
    *   **不后向兼容 $4G$**：$5G$ $NR$ 是全新的设计，但可以通过双连接 ($Dual Connectivity$) 等方式与 $4G$ $LTE$ 协同工作 (例如，$NSA$ - Non-Standalone 组网模式，控制面依赖 $4G$ $EPC$，用户面使用 $5G$ $NR$)。
    *   **$MIMO$ (Multiple Input Multiple Output)**：大规模 $MIMO$ (Massive $MIMO$) 技术，使用大量天线形成高度定向的波束，提高频谱效率和连接可靠性。
*   **毫米波频率的挑战与机遇**：
    *   **优点**：可用频谱带宽非常大，因此可以实现非常高的数据速率。
    *   **缺点**：信号衰减快，穿透力差，对障碍物敏感。
    *   **解决方案**：
        *   **微小区/皮小区 (Pico-cells/Femto-cells)**：小区半径非常小 (如 $10-100$ 米)。
        *   **密集部署**：需要大量部署新的小型基站。

---

### 5. 移动性管理：永不“失联”的艺术 🔗🚶

移动性管理的核心目标是让用户在移动过程中，能够保持网络连接的连续性，并且上层应用不受影响或影响尽可能小。

#### 5.1 移动性的“光谱” 🌈

从网络的角度看，移动性可以有不同程度：

| 无移动性 (No mobility) | ...                  | ...                                    | 高移动性 (High mobility)                      |
| :----------------- | :------------------- | :------------------------------------- | :---------------------------------------- |
| 设备固定，或在网络间移动但关机。   | 设备在同一个 $AP$ 覆盖范围内移动。 | 设备在同一个服务提供商的多个 $AP$ 之间移动 (如企业 $WiFi$)。 | 设备在多个不同服务提供商的网络之间移动（如跨运营商漫游），同时保持持续的在线连接。 |
|                    |                      | **主要关注**                               | **主要关注**                                  |

#### 5.2 移动性管理的基本方法：谁来负责？ 🤔

处理移动性主要有两种思路：

1.  **让网络 (路由器) 来处理**：
    *   **思路**：路由器之间通过路由协议（如 $BGP$）通告每个移动节点的确切位置（例如，其永久 $IP$ 地址当前附着在哪个子网）。
    *   **优点**：对移动节点和通信对端完全透明。
    *   **缺点**：
        *   $\boxed{ \text{可扩展性极差 (not scalable)。} }$ 互联网核心路由器无法维护全球数十亿移动设备的精确路由表项，这将导致路由表爆炸和大量的路由更新。
        *   对现有互联网路由基础设施改动巨大。
    *   **结论**：这种方法不适用于大规模的全局移动性。

2.  **让端系统 (End-systems) 来处理：在网络“边缘”实现功能**：
    *   这是目前主流的方法。核心网络基本保持不变，移动性管理功能主要由移动设备本身、其家乡网络和其当前访问的拜访网络中的特定实体来协同完成。
    *   主要策略包括：
        *   **间接路由 (Indirect Routing)**
        *   **直接路由 (Direct Routing)**

#### 5.3 “家”与“客”：家乡网络与拜访网络 🏠🤝🌍

理解移动性管理的关键是**家乡网络 (Home Network)** 和**拜访网络 (Visited Network)** 的概念。

*   **类比**：想象一下你的手机号码。你有一个归属地（家乡网络），即使你漫游到外地（拜访网络），别人仍然拨打你的原始号码就能找到你。你的归属地运营商需要知道你当前在哪里，以便把电话转接过去。
*   **家乡网络 (Home Network)**：
    *   移动设备永久归属的网络。
    *   通常拥有一个该网络的永久 $IP$ 地址（逻辑上的，不一定一直使用）。
    *   家乡网络中有一个**家乡代理 (Home Agent)** 或类似实体 (如 $LTE$ 中的 $HSS$ 和 $P-GW$)，负责：
        *   维护移动设备的永久信息 (如 $IP$ 地址、身份、服务配置)。
        *   **跟踪移动设备的当前位置** (例如，它当前在哪个拜访网络，其临时地址是什么)。
        *   在间接路由中，截获发往移动设备的永久 $IP$ 地址的数据包，并将其**转发 (隧道)** 到移动设备的当前位置。
*   **拜访网络 (Visited Network)**：
    *   移动设备当前临时接入的网络。
    *   拜访网络中可能有一个**外地代理 (Foreign Agent)** 或类似实体 (如 $LTE$ 中的 $MME$ 和 $S-GW$)，负责：
        *   为来访的移动设备分配一个**转交地址 (Care-of Address, $CoA$)**，这是移动设备在拜访网络上的临时 $IP$ 地址。
        *   与家乡代理通信，**注册** $CoA$，告知家乡代理移动设备的新位置。
        *   在间接路由中，接收从家乡代理隧道过来的数据包，解封装后转发给移动设备。
*   **通信对端 (Correspondent Node, $CN$)**：任何想与移动设备通信的其他主机。

#### 5.4 注册：让“家”知道你在哪儿 📍

当移动设备进入一个新的拜访网络并获得一个 $CoA$ 后，它 (或拜访网络的外地代理) 必须向其家乡网络的家乡代理**注册**这个新的 $CoA$。

*   **结果**：
    *   拜访网络的外地代理知道该移动设备在其管理之下。
    *   家乡网络的家乡代理 (或 $HSS$) 更新记录，知道移动设备的当前 $CoA$ (即其当前位置)。
![](Pic/Pasted%20image%2020250530005622.png)
#### 5.5 间接路由 (Indirect Routing) 迂回策略 🔄

这是实现移动性的一种经典方法，对通信对端完全透明。

*   **工作流程**：
    1.  **$CN$ 发送数据**：$CN$ 像往常一样，将数据包发送到移动设备的**永久 $IP$ 地址** (Home Address)。
    2.  **家乡代理截获与隧道**：数据包到达移动设备的家乡网络。家乡代理截获此数据包。家乡代理查找移动设备的当前 $CoA$，然后将原始数据包**封装 (encapsulate)** 在一个新的 $IP$ 包中 (形成一个**隧道**)，新的 $IP$ 包的目的地址是 $CoA$，源地址是家乡代理的地址。
    3.  **外地代理接收与解封装**：封装后的数据包通过互联网路由到拜访网络。拜访网络的外地代理接收到这个包，**解封装 (decapsulate)**，取出原始数据包。
    4.  **外地代理转发给 $MN$**：外地代理将原始数据包转发给在其本地网络中使用 $CoA$ (或其内部地址) 的移动设备 ($MN$)。
    5.  **$MN$ 回复数据 (通常)**：$MN$ 通常可以直接将回复数据包发送给 $CN$，无需经过家乡代理 (除非有策略限制或为了隐藏 $CoA$)。这可能导致所谓的**三角路由 (Triangle Routing)** 问题。

    ![](Pic/Pasted%20image%2020250530005854.png)
    (图解：间接路由流程。1. $CN$ 发给 $MN$ 的永久地址。 2. 家乡代理截获，隧道转发给 $CoA$ (外地代理)。 3. 外地代理解封装给 $MN$。 4a. $MN$ 回复时，如果通过家乡代理。 4b. $MN$ 回复时，如果直接回复 $CN$。)

*   **间接路由的特点**：
    *   **对 $CN$ 透明**：$CN$ 不需要知道 $MN$ 的当前位置或 $CoA$。$CN$ 始终使用 $MN$ 的永久 $IP$ 地址。
    *   **$MN$ 移动的透明性**：当 $MN$ 移动到新的拜访网络并注册新的 $CoA$ 后，数据流会自动重定向，对 $CN$ 和正在进行的连接 (如 $TCP$ 连接) 通常是透明的 (可能会有短暂中断和性能抖动)。
    *   **三角路由问题**：如果 $MN$ 的回复直接发送给 $CN$，而 $CN$ 发给 $MN$ 的数据却要绕道家乡代理，形成了一个低效的三角路径，增加了延迟。尤其是当 $CN$ 和 $MN$ 实际上在同一个拜访网络或邻近网络时。
    *   $\boxed{ \text{正在进行的连接 (如 } TCP \text{ 连接) 通常可以被维持。} }$

#### 5.6 直接路由 (Direct Routing) 直达策略 (需要 $CN$ 配合) 🎯

为了克服三角路由的低效，直接路由允许 $CN$ 直接将数据包发送到 $MN$ 的当前 $CoA$。

*   **工作流程 (一种可能的实现)**：
    1.  **$CN$ 获取 $CoA$**：当 $CN$ 第一次想与 $MN$ 通信时，它可能先向 $MN$ 的家乡代理查询 $MN$ 的当前 $CoA$。或者，家乡代理在收到第一个发往 $MN$ 的数据包后，除了将其隧道转发给 $MN$ 外，还可能通知 $CN$ 关于 $MN$ 的当前 $CoA$ (例如通过 $ICMP$ 重定向消息的扩展)。
    2.  **$CN$ 直接发送**：$CN$ 获得 $CoA$ 后，后续的数据包可以直接发送到 $MN$ 的 $CoA$。
    3.  **$MN$ 回复**：$MN$ 直接回复给 $CN$。
    ![](Pic/Pasted%20image%2020250530005949.png)
    (图解：直接路由流程。1. $CN$ 联系家乡代理/HSS 获取 $MN$ 的 $CoA$。2. 家乡代理/HSS 回复 $CoA$。3. $CN$ 直接发送数据到 $MN$ 的 $CoA$。4. 外地代理/网关将数据转发给 $MN$。)

*   **直接路由的特点**：
    *   **克服了三角路由**：路由路径更优。
    *   **对 $CN$ 不再透明**：$CN$ 必须有能力获取并使用 $MN$ 的 $CoA$。这通常需要 $CN$ 的操作系统或网络协议栈支持特定的移动性协议。
    *   **$MN$ 移动时的复杂性**：
        *   当 $MN$ 移动到新的拜访网络，获得新的 $CoA$ 并重新注册后，**$CN$ 必须被通知这个新的 $CoA$**。否则，$CN$ 仍会向旧的 $CoA$ 发送数据，导致通信中断。
        *   这使得维持现有连接 (如 $TCP$) 变得更加复杂，可能需要额外的机制来处理 $CoA$ 的变化并“修复”连接。

#### 5.7 $4G/5G$ 网络中的移动性管理实践 🛠️

$4G$ 和 $5G$ 网络使用复杂的机制来实现高效的移动性管理，这些机制融合了间接路由和直接路由的思想，并有大量的优化。

*   **主要移动性任务**：
    1.  **基站关联**：$UE$ 与 $eNodeB/gNodeB$ (5G基站) 建立无线连接（已在前述“附着过程”中讨论）。这包括 $UE$ 向网络提供其 $IMSI$ 以便识别自身和其家乡网络。
    2.  **控制平面配置**：
        *   $MME$ (或 $5G$ 中的 $AMF$ - Access and Mobility Management Function) 与 $UE$ 的家乡网络 $HSS$ (或 $5G$ 中的 $UDM$ - Unified Data Management) 交互，建立控制平面状态，确认 $UE$ 在当前拜访网络中是合法的、经过认证的。
    3.  **数据平面配置 (Data-Plane Configuration)**：
        *   $MME/AMF$ 配置转发隧道，以便用户数据可以在 $UE$、当前基站、$S-GW/UPF$ (User Plane Function in 5G)、$P-GW/SMF$ (Session Management Function in 5G) 和外部网络之间流动。
        *   家乡网络的 $P-GW$ (或 $5G$ 中的 $UPF$ 作为会话锚点) 通常作为 $UE$ 的 $IP$ 地址锚点和通往互联网的出口。这是一种间接路由的体现。
    4.  **移动切换 (Mobile Handover)**：当 $UE$ 从一个基站的覆盖区移动到另一个基站的覆盖区时，其网络连接需要平滑地从旧基站切换到新基站。

*   **配置 $LTE$ 控制平面元素** (回顾)：
    *   $UE$ 通过当前基站的控制信道与本地 $MME$ 通信。
    *   $MME$ 使用 $UE$ 的 $IMSI$ 联系其家乡 $HSS$，获取认证信息、加密密钥、网络服务信息等。
    *   $HSS$ 记录 $UE$ 当前由哪个 $MME$ 服务。
    *   基站和 $UE$ 协商数据平面无线参数。

*   **为移动设备配置数据平面隧道** (回顾)：
    *   **$S-GW$ 到基站的隧道**：当 $UE$ 在基站间切换时，这个隧道的基站端点会改变，但 $S-GW$ 端点通常保持不变（在同一 $S-GW$ 服务区内切换时）。
    *   **$S-GW$ 到家乡 $P-GW$ 的隧道**：这是间接路由的核心实现。$UE$ 的所有数据都会经过其家乡 $P-GW$ (作为锚点) 进出互联网。
    *   **使用 $GTP$ 隧道**：用户数据包被封装在 $GTP$ 协议中，在 $EPC$ 网元之间传输。

*   **同一蜂窝网络内基站间的切换 (Handover)** 🔄🗼：
    这是一个精心设计的流程，以最小化切换过程中的数据丢失和延迟。
    1.  **准备阶段**：当前服务基站 (源基站) 根据 $UE$ 的测量报告（如邻近小区的信号强度）决定启动切换，并选择一个目标基站。
    2.  **源基站 $\to$ 目标基站**：源基站向目标基站发送**切换请求 (Handover Request)** 消息，包含 $UE$ 的上下文信息 (如安全参数、服务质量要求等)。
    3.  **资源预分配**：目标基站预先为 $UE$ 分配无线资源（如时隙、频率）。分配成功后，向源基站回复**切换请求确认 (Handover Request Acknowledge)**，其中包含用于 $UE$ 接入目标基站的参数。
    4.  **指令 $UE$ 切换**：源基站向 $UE$ 发送**切换指令 (Handover Command)**，告诉 $UE$ 切换到目标基站，并提供必要的接入参数。
    5.  **$UE$ 同步到目标基站**：$UE$ 与目标基站建立同步，并发送**切换完成 (Handover Complete/Confirm)** 消息给目标基站。此时，$UE$ 认为切换在外观上已完成，可以开始通过新基站收发数据。
    6.  **路径切换**：
        *   目标基站通知 $MME/S-GW$，表明 $UE$ 现在由它服务。
        *   $MME/S-GW$ 更新数据路径，将下行数据隧道从旧基站重定向到新基站。
        *   **数据转发 (Data Forwarding)**：在路径切换完成前，为了减少数据丢失，源基站可能会将其缓冲的以及新到达的下行数据转发给目标基站，再由目标基站发给 $UE$。
    7.  **资源释放**：一旦切换成功且稳定，源基站会释放之前为 $UE$ 分配的资源。

#### 5.8 移动 $IP$ ($Mobile$ $IP$) 📜 (历史视角)

*   移动 $IP$ ($RFC$ $5944$) 是一个较早（大约 $20$ 年前）标准化的，用于在 $IP$ 网络中支持移动性的协议。
*   **背景**：它在智能手机和 $4G$ 网络普及之前就被提出，旨在解决 $IP$ 层的移动性问题。
*   **实际部署**：尽管是标准，但移动 $IP$ 并未得到广泛的部署和使用。
    *   原因可能包括：其复杂性、对网络基础设施的要求、以及当时 $WiFi$ (用于互联网接入) 和 $2G/3G$ (主要用于语音) 在一定程度上“足够好”地满足了用户需求。
*   **移动 $IP$ 架构**：
    *   采用**间接路由**，通过家乡网络中的隧道进行通信。
    *   **家乡代理 (Home Agent, $HA$)**：角色类似于 $4G$ $HSS$ + 家乡 $P-GW$ 的组合。负责维护 $MN$ 的当前 $CoA$，截获发往 $MN$ 永久地址的数据包并隧道转发。
    *   **外地代理 (Foreign Agent, $FA$)**：角色类似于 $4G$ $MME$ + $S-GW$ 的组合。位于拜访网络，为 $MN$ 提供服务，如分配 $CoA$ (如果 $FA$ 提供 $CoA$)，解封装来自 $HA$ 的隧道数据包。$MN$ 也可以自己获取 $CoA$ (称为同址 $CoA$, co-located $CoA$)。
    *   **代理发现 (Agent Discovery)**：$MN$ 通过 $ICMP$ 扩展协议（代理通告和代理请求消息）来发现家乡代理和外地代理。
    *   **注册 (Registration)**：$MN$ 向其 $HA$ 注册其当前的 $CoA$。

### 6. 无线与移动性对上层协议的影响 ⚡

无线链路的特性和用户移动性，虽然在理想情况下应尽量对上层协议透明，但实际上会对性能产生影响。

*   **逻辑上影响应最小**：
    *   尽力而为 (Best-effort) 的服务模型保持不变。
    *   $TCP$ 和 $UDP$ 仍然可以在无线和移动环境上运行（并且确实在运行）。
*   **但性能上会有影响**：
    *   **丢包和延迟**：
        *   无线链路固有的高误码率 ($BER$) 会导致数据包损坏或丢失（即使有链路层重传，也可能超时或达到重传上限）。
        *   链路层重传会引入额外延迟。
        *   切换 (Handover) 过程本身也会引入短暂的丢包和延迟。
    *   **$TCP$ 的误判**：
        *   $TCP$ 通常将丢包视为网络拥塞的信号，从而不必要地减小其拥塞窗口、降低发送速率。
        *   这在无线环境中是不合适的，因为丢包更可能是由无线链路的差错或切换引起的，而非网络拥塞。
        *   导致 $TCP$ 吞吐量下降。
    *   **对实时应用的延迟影响**：
        *   无线链路的抖动（延迟变化）和切换延迟对实时应用（如网络电话、视频会议）的体验有显著影响。
    *   **带宽是稀缺资源**：
        *   无线频谱有限，单个用户的可用带宽通常比有线连接要低且更不稳定。
        *   协议头部开销（如 $TCP/IP$ 头部）在低带宽链路上占比更大，效率更低。

### 7. 总结 回顾本章核心 🎯

本章我们深入探讨了无线与移动网络的世界：

*   **无线链路与网络特性** 📡：
    *   信号衰减、干扰、多径传播是主要挑战。
    *   $SNR$ 和 $BER$ 是衡量链路质量的关键指标。
    *   隐藏终端和暴露终端问题影响共享介质的效率。
*   **$IEEE$ $802.11$ ($WiFi$)** 💻：
    *   架构：$BSS$, $AP$。
    *   关联过程：扫描、认证、关联。
    *   介质访问：$CSMA/CA$ 结合随机退避和 $ACK$，可选的 $RTS/CTS$ 机制。
    *   帧结构：多地址字段以支持与 $AP$ 和有线网络的交互。
    *   高级功能：速率自适应、电源管理。
*   **蜂窝网络 ($4G$ $LTE$ / $5G$)** 📱：
    *   架构：$UE, eNodeB/gNodeB, MME/AMF, S-GW/UPF, P-GW/SMF, HSS/UDM$。
    *   数据平面与控制平面分离，广泛使用隧道技术 ($GTP$)。
    *   $LTE$ 协议栈：$PDCP, RLC, MAC, PHY$。
    *   $5G$ 的目标与新技术（毫米波、$NR$）。
*   **移动性管理原理** 🚶：
    *   家乡网络 vs. 拜访网络，家乡代理 vs. 外地代理，永久地址 vs. 转交地址 ($CoA$)。
    *   注册过程。
    *   间接路由（三角路由问题）与直接路由（对 $CN$ 不透明，切换复杂性）。
*   **$4G/5G$ 中的移动性实践** 🛠️：
    *   切换 (Handover) 是关键流程，旨在实现平滑过渡。
*   **对上层协议的影响** ⚡：
    *   无线丢包和延迟可能导致 $TCP$ 性能下降，影响实时应用。

无线与移动网络是现代通信的基石，理解其原理对于设计和优化依赖于它们的各种应用和服务至关重要。随着技术的不断发展 (如 $6G$ 的研究已经开始)，这个领域将持续充满挑战与机遇！

---

希望这份笔记能够帮助你更好地理解无线与移动网络！ 🎉