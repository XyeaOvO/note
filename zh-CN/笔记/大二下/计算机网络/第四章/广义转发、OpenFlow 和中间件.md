# 广义转发、OpenFlow 和中间件

接续之前的“IP 协议核心”部分，本节继续探索网络层数据平面的高级概念，包括广义转发、OpenFlow 和中间件。

### 🔍 广义转发: 匹配+动作

传统的基于目的地址的转发可以看作是一种“匹配+动作”的特例。广义转发将其扩展，提供了更灵活的数据包处理能力。

*   **回顾**: 每个路由器包含一个**转发表**，在广义转发的语境下，也称为**流表**。
*   **"匹配+动作"抽象**: 这是广义转发的核心思想。
    *   **匹配**: 检查到达数据包**头部**中的一个或多个字段的值。不再局限于目的 IP 地址。
    *   **动作**: 根据匹配结果，对数据包执行相应的操作。
*   **对比**:
    *   **基于目的地的转发**: 仅匹配目的 IP 地址，动作为转发到特定输出端口。
    *   **广义转发**:
        *   可以匹配**多个头部字段**来确定动作。
        *   可以执行**多种动作**，例如：转发、丢弃、复制、修改头部字段、记录日志、或者将数据包发送给中央控制器处理。
*   **流表抽象**:
    *   **流**: 由数据包头部字段的值定义的一系列数据包（可以跨越链路层、网络层、传输层字段）。
    *   **流表条目**: 定义了简单的包处理规则，通常包含：
        1.  **`匹配字段`**: 定义了用于匹配入站数据包头部的模式值。可以使用**通配符**表示任意值。
            *   示例:
                *   `src = *.*.*.*, dest = 3.4.*.*` -> 匹配所有源 IP，目的 IP 前缀为 `3.4` 的数据包。
                *   `src = 1.2.*.*, dest = *.*.*.*` -> 匹配所有源 IP 前缀为 `1.2` 的数据包。
                *   `src = 10.1.2.3, dest = *.*.*.*` -> 匹配特定源 IP `$10.1.2.3$` 的数据包。
        2.  **`动作`**: 当数据包匹配该条目时执行的操作。
            *   示例: `forward`, `drop`, `send to controller`。
        3.  **`优先级`**: 用于解决当一个数据包可能匹配多个流表条目时的冲突，通常选择优先级最高的匹配条目。
        4.  **`计数器`**: 统计匹配该条目的字节数和数据包数量，用于网络监控和管理。
    *   $\boxed{\text{路由器的流表定义了其 '匹配+动作' 的规则集合}}$

---

### 🚦 OpenFlow: 流表实践

OpenFlow 是实现“匹配+动作”广义转发模型的一个具体的、标准化的协议接口。它允许远程控制器管理网络设备（如交换机、路由器）的流表。
![](Pic/Pasted%20image%2020250417073735.png)
*   **OpenFlow 流表条目**:
    *   **匹配**: 可以匹配非常广泛的头部字段：
        *   **链路层**: 入端口, 源/目的 MAC 地址, EtherType, VLAN ID, VLAN Priority。
        *   **网络层**: 源/目的 IP 地址, IP 协议号, IP 服务类型。
        *   **传输层**: 源/目的 TCP/UDP 端口号。
    *   **动作**:
        1.  转发数据包到指定端口)。
        2.  丢弃数据包。
        3.  修改头部字段)。
        4.  封装并转发给控制器。
    *   **统计**: 包含数据包和字节计数器。

*   **OpenFlow 示例**:
    1.  **基于目的地的转发**:
        *   匹配: `IP Dst = 51.6.0.8`
        *   动作: `forward`
        *   含义: 将所有目的 IP 地址为 `$51.6.0.8$` 的 IP 数据报转发到路由器的 6 号输出端口。
    2.  **防火墙**:
        *   示例 1: 阻止 SSH 访问
            *   匹配: `IP Proto = TCP`, `TCP Dst Port = 22`
            *   动作: `drop`
            *   含义: 阻止所有目标端口为 `$22$`的 TCP 连接。
        *   示例 2: 阻止特定主机外发流量
            *   匹配: `IP Src = 128.119.1.1`
            *   动作: `drop`
            *   含义: 阻止所有源 IP 地址为 `$128.119.1.1$` 的主机发送的数据报。
    3.  **二层基于 MAC 的转发**:
        *   匹配: `Dst MAC = 22:A7:23:11:E1:02`
        *   动作: `forward`
        *   含义: 将所有目的 MAC 地址为 `$22:A7:23:11:E1:02$` 的二层帧转发到交换机的 3 号输出端口。

*   **统一抽象**: "匹配+动作"模型提供了一种统一的方式来描述不同网络设备的功能：
    *   **路由器**: 匹配最长目的 IP 前缀，动作是转发。
    *   **交换机**: 匹配目的 MAC 地址，动作是转发或泛洪。
    *   **防火墙**: 匹配 IP 地址和 TCP/UDP 端口号，动作是允许或拒绝。
    *   **NAT**: 匹配 IP 地址和端口号，动作是重写地址和端口号。

*   **网络范围的行为协调**:
    *   通过一个**中央 OpenFlow 控制器**，可以编程协调多个 OpenFlow 交换机的流表，实现复杂的、网络范围的流量工程策略。
    * ![](Pic/Pasted%20image%2020250417074518.png)
    *   **示例**: 要求来自主机 h5和 h6的数据报，如果要发往 h3或 h4，必须先经过 s1，再转发给 s2。
        *   **s3 的流表**: 匹配 `IP Src = 10.3.*.*`, `IP Dst = 10.2.*.*` -> `action = forward`。
        *   **s1 的流表**:
            *   匹配 `ingress port = 1`, `IP Src = 10.3.*.*`, `IP Dst = 10.2.0.3` -> `action = forward`。
            *   匹配 `ingress port = 1`, `IP Src = 10.3.*.*`, `IP Dst = 10.2.0.4` -> `action = forward`。
        *   **s2 的流表**:
            *   匹配 `ingress port = 2`, `IP Dst = 10.2.0.3` -> `action = forward`。
            *   匹配 `ingress port = 2`, `IP Dst = 10.2.0.4` -> `action = forward`。

*   **广义转发总结**:
    *   "匹配+动作" 允许跨越多层协议头部进行匹配，并执行灵活的本地动作。
    *   可以"编程"实现网络范围的行为。
    *   是一种简单的“网络可编程性”形式。
    *   其历史根源可追溯到主动网络。
    *   现代发展: 更通用的网络编程语言如 P4。

---

### 📦 中间件

中间件是位于源主机和目的主机之间数据路径上的、执行**超出标准 IP 路由器**功能的网络设备。

*   **定义** :
    $\boxed{\text{"任何在源主机和目的主机之间的数据路径上，执行除了 IP 路由器正常、标准功能之外功能的中间盒子"}}$
*   **无处不在**: 中间件广泛存在于各种网络环境中：
    *   **NAT**: 家庭网络、蜂窝网络、机构网络。
    *   **防火墙, 入侵检测系统**: 企业、机构、服务提供商、ISP。
    *   **负载均衡器**: 企业、服务提供商、数据中心、移动网络。
    *   **缓存**: 服务提供商、移动网络、内容分发网络。
    *   **应用特定中间件**: 服务提供商、机构、CDN。
*   **演进**:
    *   **初期**: 专有的、封闭的硬件解决方案。
    *   **发展**: 趋向于使用实现开放 API 的“白盒”硬件。
        *   摆脱专有硬件。
        *   通过“匹配+动作”实现可编程的本地行为。
        *   软件层面的创新和差异化。
    *   **现代趋势**:
        *   **SDN**:集中的控制和配置管理，常见于私有/公有云。
        *   **NFV**: 在通用的白盒网络、计算和存储硬件上，以软件形式实现可编程的网络服务。

---

### 🏛️ 互联网架构演进与原则

中间件的广泛使用也引发了对互联网核心架构原则的反思。

*   **IP 沙漏模型:
    *   互联网的“**细腰**”：IP 是唯一的、通用的网络层协议。
    *   **必须**被数十亿互联网连接设备实现。
    *   IP 之上是多样的传输层和应用层协议。
    *   IP 之下是多样的物理层和链路层技术。
    ![](Pic/Pasted%20image%2020250417082333.png)

*   **沙漏模型的中年？:
    *   互联网的“中年发福”?
    *   大量的**中间件**运行在网络**内部**。
    *   这些中间件检查甚至修改 IP 数据报内部的内容（包括传输层端口号），某种程度上“增厚”了原本简洁的 IP 腰部。
    * ![](Pic/Pasted%20image%2020250417082530.png)
*   **互联网的架构原则**:
    *   $\boxed{\text{目标是连接性，工具是IP协议，智能在网络边缘}}$
    *   **三大基石信念**:
        1.  **简单的连接性**: 网络核心尽可能简单，主要负责数据包转发。
        2.  **IP 协议**: 作为通用的“窄腰”。
        3.  **智能与复杂性在网络边缘**: 端系统（主机）负责处理复杂的逻辑（如可靠传输、拥塞控制、应用逻辑）。
![](Pic/Pasted%20image%2020250417090332.png)

---

### ✅ 本章小结与展望

本章（网络层：数据平面）主要内容回顾:

*   网络层概述
*   路由器内部结构
*   IP 协议
*   广义转发与 SDN
*   中间件

**🤔 遗留问题**: 我们已经了解了路由器/交换机如何根据（目的地址）转发表或（广义）流表来转发数据包。但是，这些**表是如何计算和建立起来的呢？**

**答案**: 由**控制平面** 负责。这将在下一章深入探讨。